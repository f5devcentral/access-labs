<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>Lab 1: Implement C3D with APM Enhancements</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="Lab 1: Implement C3D with APM Enhancements"/>
  <meta name="product" content="F5 Identity and Access Management Solutions"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2021-06-21 14:22:47"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 Identity and Access Management Solutions" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab 1: Implement C3D with APM Enhancements &#8212; F5 Identity and Access Management Solutions  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/CoveoFullSearch.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/21fb8a09c3.css" type="text/css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Lab 2: Implement Priviledged User Access Authentication" href="lab02.html" />
    <link rel="prev" title="Environment Overview" href="intro.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 Identity and Access Management Solutions  </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../class1/class1.html">100 Series: Access Foundational Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class2/class2.html">200 Series: Assisted Deployment Use Cases</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../class3.html">300 Series: Advanced Use Cases &amp; Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class4/class4.html">400 Series: Access Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class5/class5.html">500 Series: Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archived/archived.html">Archived Identity &amp; Access Management Labs</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">Lab 1: Implement C3D with APM Enhancements</a><ul>
<li><a class="reference internal" href="#task-1-setup-lab-environment">Task 1 - Setup Lab Environment</a></li>
<li><a class="reference internal" href="#task-2-create-an-active-directory-aaa-object">Task 2 - Create an Active Directory AAA Object</a></li>
<li><a class="reference internal" href="#task-3-create-a-radius-aaa-object">Task 3 - Create a RADIUS AAA Object</a></li>
<li><a class="reference internal" href="#task-4-create-the-cert-sso-access-profile">Task 4 - Create the cert_sso Access Profile</a></li>
<li><a class="reference internal" href="#task-5-create-the-access-policy">Task 5 - Create the Access Policy</a></li>
<li><a class="reference internal" href="#task-6-create-a-client-ssl-profile">Task 6 - Create a Client SSL Profile</a></li>
<li><a class="reference internal" href="#task-7-create-a-server-ssl-profile">Task 7 - Create a Server SSL Profile</a></li>
<li><a class="reference internal" href="#task-8-create-the-pool">Task 8 - Create the Pool</a></li>
<li><a class="reference internal" href="#task-9-create-a-virtual-server">Task 9 - Create a Virtual Server</a></li>
<li><a class="reference internal" href="#task-10-test-certsso">Task 10 - Test CertSSO</a></li>
<li><a class="reference internal" href="#task-11-create-an-http-connector-transport">Task 11 - Create an HTTP Connector Transport</a></li>
<li><a class="reference internal" href="#task-12-create-a-http-connector-request">Task 12 - Create a HTTP Connector Request</a></li>
<li><a class="reference internal" href="#task-13-create-a-per-request-policy">Task 13 - Create a Per-Request Policy</a></li>
<li><a class="reference internal" href="#task-14-attach-the-prp-to-the-mtls-virtual-server">Task 14 - Attach the PRP to the mTLS Virtual Server</a><ul>
<li><a class="reference internal" href="#task-15-access-mtls-acme-com-with-dynamic-certificate">Task 15 - Access mtls.acme.com with Dynamic Certificate</a></li>
</ul>
</li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">F5 Identity and Access Management Solutions</a>
              &gt; <a href="../class3.html">300 Series: Advanced Use Cases &amp; Solutions</a>

          <span class="right">
             <a href="../../_sources/class3/module2/lab01.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/f5devcentral/f5-agility-labs-iam">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="lab-1-implement-c3d-with-apm-enhancements">
<h1>Lab 1: Implement C3D with APM Enhancements<a class="headerlink" href="#lab-1-implement-c3d-with-apm-enhancements" title="Permalink to this headline">¶</a></h1>
<p>Expected time to complete: <strong>1 hour</strong></p>
<div class="section" id="task-1-setup-lab-environment">
<h2>Task 1 - Setup Lab Environment<a class="headerlink" href="#task-1-setup-lab-environment" title="Permalink to this headline">¶</a></h2>
<p>To access your dedicated student lab environment, you will need a web browser and Remote Desktop Protocol (RDP) client software. The web browser will be used to access the Unified Demo Framework (UDF) Training Portal. The RDP client will be used to connect to the jumphost, where you will be able to access the BIG-IP management interfaces (HTTPS, SSH).</p>
<ol class="arabic">
<li><p class="first">Click <strong>DEPLOYMENT</strong> located on the top left corner to display the environment</p>
</li>
<li><p class="first">Click <strong>ACCESS</strong> next to jumpbox.f5lab.local</p>
<p><img alt="image090" src="../../_images/0902.png" /></p>
</li>
<li><p class="first">Select your RDP resolution.</p>
</li>
<li><p class="first">The RDP client on your local host establishes a RDP connection to the Jump Host.</p>
</li>
<li><dl class="first docutils">
<dt>Login with the following credentials:</dt><dd><ul class="simple">
<li>User: <strong>f5lab\user1</strong></li>
<li>Password: <strong>user1</strong></li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">After successful logon the Chrome browser will auto launch opening the site <a class="reference external" href="https://portal.f5lab.local">https://portal.f5lab.local</a>.  This process usually takes 30 seconds after logon.</p>
<blockquote>
<div><p><img alt="image091" src="../../_images/0913.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click the <strong>Classes</strong> tab at the top of the page.</p>
</li>
<li><p class="first">Scroll down the page until you see <strong>302 Ephemeral Authentication</strong> on the left</p>
<p><img alt="image087" src="../../_images/0873.png" /></p>
</li>
<li><p class="first">Hover over tile <strong>Implement C3D with APM Enchancements</strong>. A start and stop icon should appear within the tile.  Click the <strong>Play</strong> Button to start the automation to build the environment</p>
<p><img alt="image088" src="../../_images/0883.png" /></p>
</li>
<li><p class="first">The screen should refresh displaying the progress of the automation within 30 seconds.  Scroll to the bottom of the automation workflow to ensure all requests succeeded.  If you you experience errors try running the automation a second time or open an issue on the <a class="reference external" href="https://github.com/f5devcentral/access-labs">Access Labs Repo</a>.</p>
<p><img alt="image089" src="../../_images/0893.png" /></p>
</li>
</ol>
</div>
<div class="section" id="task-2-create-an-active-directory-aaa-object">
<h2>Task 2 - Create an Active Directory AAA Object<a class="headerlink" href="#task-2-create-an-active-directory-aaa-object" title="Permalink to this headline">¶</a></h2>
<p>The first step in deploying CertSSO is creating the objects required for the user to authenticate to APM.  In this lab, the user will authenticate via Active Directory and simulated MFA via RADIUS.  The user’s authentication method to APM is independent of how the BIG-IP authenticates the user to the backend server for Single-Sign-On.  This allows an organization to choose an authentication scheme that matches their needs such as SAML, OAuth, or other method.</p>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Access &gt;&gt; Authentication &gt;&gt; Active Directory</strong>, then click the <strong>+</strong> (plus symbol) to create a new AAA object</p>
<p><img alt="image001" src="../../_images/image0019.png" /></p>
</li>
<li><p class="first">Enter the following information for the AD Authentication Object</p>
<ul class="simple">
<li>Name: <strong>ad_servers</strong></li>
<li>Domain Name: <strong>f5lab.local</strong></li>
<li>Domain Controller Pool Name: <strong>ad_pool</strong></li>
<li>Domain Controller IP address: <strong>10.1.20.7</strong></li>
<li>Domain Controller Hostname: <strong>dc1.f5lab.local</strong></li>
<li>Admin name: <strong>admin</strong></li>
<li>Admin Password: <strong>admin</strong></li>
</ul>
<p><a class="reference internal" href="../../_images/00215.png"><img alt="image002" src="../../_images/00215.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
</li>
</ol>
</div>
<div class="section" id="task-3-create-a-radius-aaa-object">
<h2>Task 3 - Create a RADIUS AAA Object<a class="headerlink" href="#task-3-create-a-radius-aaa-object" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Access &gt;&gt; Authentication &gt;&gt; RADIUS</strong>, then click the <strong>+</strong> (plus symbol) to create a new AAA object</p>
<p><img alt="image003" src="../../_images/image0039.png" /></p>
</li>
<li><p class="first">Enter the following information for the Radius Authentication Object</p>
<ul class="simple">
<li>Name: <strong>radius_servers</strong></li>
<li>Server Pool Name: <strong>radius_pool</strong></li>
<li>Server Addresses: <strong>10.1.20.8</strong></li>
<li>Secret password: <strong>secret</strong></li>
</ul>
<p><a class="reference internal" href="../../_images/image0049.png"><img alt="image004" src="../../_images/image0049.png" style="width: 700px;" /></a></p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
</li>
</ol>
</div>
<div class="section" id="task-4-create-the-cert-sso-access-profile">
<h2>Task 4 - Create the cert_sso Access Profile<a class="headerlink" href="#task-4-create-the-cert-sso-access-profile" title="Permalink to this headline">¶</a></h2>
<p>In this section, you will create the APM Access Profile.</p>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Access &gt;&gt; Profile/ Policies &gt;&gt; Access Profile(Per-Session Policies)</strong>, then click the <strong>+</strong> (plus symbol) to create a new Access Profile</p>
<p><img alt="image005" src="../../_images/image0059.png" /></p>
</li>
<li><p class="first">Enter the Name <strong>cert_sso</strong></p>
</li>
<li><p class="first">Select the profile Type <strong>All</strong> from the dropdown</p>
<p><a class="reference internal" href="../../_images/image0069.png"><img alt="image006" src="../../_images/image0069.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Scroll to the bottom of the profile settings to set the default language to <strong>English</strong></p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
<p><img alt="image007" src="../../_images/image0079.png" /></p>
</li>
</ol>
</div>
<div class="section" id="task-5-create-the-access-policy">
<h2>Task 5 - Create the Access Policy<a class="headerlink" href="#task-5-create-the-access-policy" title="Permalink to this headline">¶</a></h2>
<p>In this section, edit the policy using the Visual Policy Editor to enable users to login via AD+MFA, then transition to CertSSO.</p>
<ol class="arabic">
<li><p class="first">On the cert_sso profile line click <strong>edit</strong> under Per-Session Policy</p>
<p><img alt="image008" src="../../_images/image0089.png" /></p>
</li>
<li><p class="first">Click the <strong>+</strong> (plus symbol) located on the fallback branch located between the <strong>Start</strong> and <strong>Deny</strong> boxes</p>
<p><img alt="image009" src="../../_images/image0099.png" /></p>
</li>
<li><p class="first">Click the <strong>Logon</strong> Tab</p>
</li>
<li><p class="first">Select <strong>Logon Page</strong></p>
</li>
<li><p class="first">Click <strong>Add Item</strong></p>
<p><img alt="image011" src="../../_images/image0117.png" /></p>
</li>
<li><p class="first">Add an additional field to the logon page by selecting <strong>password</strong> from the <strong>Type</strong> dropdown (line 3)</p>
</li>
<li><p class="first">Enter <strong>OTP</strong> for <strong>Post Variable Name</strong></p>
</li>
<li><p class="first">Enter <strong>OTP</strong> for <strong>Session Variable Name</strong></p>
</li>
<li><p class="first">Enter <strong>OTP</strong> for <strong>Logon Page Input Field #3</strong></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image012" src="../../_images/image0127.png" /></p>
</li>
<li><p class="first">Click the <strong>+</strong> (plus symbol) located on the fallback branch located between the <strong>Logon Page</strong> and <strong>Deny</strong> boxes</p>
<p><img alt="image013" src="../../_images/image0137.png" /></p>
</li>
<li><p class="first">Click the <strong>Authentication</strong> tab</p>
</li>
<li><p class="first">Select <strong>RADIUS Auth</strong></p>
</li>
<li><p class="first">Click <strong>Add Item</strong></p>
<p><img alt="image014" src="../../_images/image0147.png" /></p>
</li>
<li><p class="first">Select <strong>radius_servers</strong> from the <strong>AAA Server</strong> dropdown box</p>
</li>
<li><p class="first">Change the password source to <strong>%{session.logon.last.OTP}</strong></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><a class="reference internal" href="../../_images/image0157.png"><img alt="image015" src="../../_images/image0157.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Click the <strong>+</strong> (plus symbol) located on the <strong>Successful</strong> branch located between <strong>RADIUS Auth</strong> and <strong>Deny</strong> boxes</p>
<p><img alt="image016" src="../../_images/image0167.png" /></p>
</li>
<li><p class="first">In the <strong>Authentication</strong> tab, select <strong>AD Auth</strong></p>
</li>
<li><p class="first">Click <strong>Add Item</strong></p>
<p><img alt="image017" src="../../_images/image0177.png" /></p>
</li>
<li><p class="first">Select <strong>ad_servers</strong> from the Server dropdown box</p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><a class="reference internal" href="../../_images/image0187.png"><img alt="image018" src="../../_images/image0187.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Click the <strong>+</strong> (plus symbol) located on the <strong>Successful</strong> branch located between <strong>AD Auth</strong> and <strong>Deny</strong> box</p>
</li>
<li><p class="first">Click <strong>Add Item</strong></p>
<p><img alt="image010" src="../../_images/image0108.png" /></p>
</li>
<li><p class="first">In the <strong>Assignment</strong> tab, select <strong>Variable Assign</strong></p>
</li>
<li><p class="first">Click <strong>Add Item</strong></p>
<p><img alt="image019" src="../../_images/image0197.png" /></p>
</li>
<li><p class="first">Click <strong>Add new entry</strong></p>
<p><img alt="image036" src="../../_images/image0366.png" /></p>
</li>
<li><p class="first">Click <strong>change</strong></p>
<p><img alt="image037" src="../../_images/image0376.png" /></p>
</li>
<li><p class="first">Enter <strong>session.ssl.cert.whole</strong> in the custom variable field</p>
<p><img alt="image038" src="../../_images/image0385.png" /></p>
</li>
<li><p class="first">Locate the <strong>F5CertSSO.f5lab.local.txt</strong> file in the <strong>C:\access-labs\class3\module2\student_files</strong> directory.</p>
<p><img alt="image039" src="../../_images/0399.png" /></p>
</li>
<li><p class="first">Open the file with <strong>notepad++</strong> and copy the contents of the file</p>
<p><img alt="image040" src="../../_images/0408.png" /></p>
</li>
<li><p class="first">Return to the <strong>Visual Policy Editor</strong> and paste the certificate into the <strong>custom expression</strong> field</p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
<p><img alt="image041" src="../../_images/image0413.png" /></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image042" src="../../_images/image0423.png" /></p>
</li>
<li><p class="first">Click the <strong>Deny</strong> ending icon located on the fallback branch of the <strong>Variable Assign</strong> agent</p>
<p><img alt="image020" src="../../_images/image0207.png" /></p>
</li>
<li><p class="first">Click <strong>Allow</strong></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image021" src="../../_images/image0217.png" /></p>
</li>
<li><p class="first">Click <strong>Apply Access Policy</strong> located in the top left corner to commit the policy changes</p>
</li>
</ol>
</div>
<div class="section" id="task-6-create-a-client-ssl-profile">
<h2>Task 6 - Create a Client SSL Profile<a class="headerlink" href="#task-6-create-a-client-ssl-profile" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Local Traffic &gt;&gt; Profiles &gt;&gt; SSL &gt;&gt; Client</strong>, then click the <strong>+</strong> (plus symbol) to create a new <strong>SSL Profile</strong></p>
<p><img alt="image023" src="../../_images/image0237.png" /></p>
</li>
<li><p class="first">Enter the name <strong>client_certsso</strong></p>
</li>
<li><p class="first"><strong>Check</strong> the <strong>custom</strong> box to the right of <strong>Certificate Key Chain</strong></p>
</li>
<li><p class="first">Click <strong>add</strong></p>
<p><a class="reference internal" href="../../_images/image0247.png"><img alt="image024" src="../../_images/image0247.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Select <strong>acme.com-wildcard</strong> from the <strong>certificate</strong> dropdown box</p>
</li>
<li><p class="first">Select <strong>acme.com-wildcard</strong> from the <strong>key</strong> dropdown box</p>
</li>
<li><p class="first">Click <strong>Add</strong></p>
<p><img alt="image025" src="../../_images/02514.png" /></p>
</li>
<li><p class="first"><strong>Check</strong> the <strong>custom</strong> box to the right of <strong>Client Certificate Constrained Delegation</strong></p>
</li>
<li><p class="first">Select <strong>Enabled</strong> from the <strong>Client Certificate Constrained Delegation</strong> dropdown box</p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
<p><a class="reference internal" href="../../_images/image0265.png"><img alt="image026" src="../../_images/image0265.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
</li>
</ol>
</div>
<div class="section" id="task-7-create-a-server-ssl-profile">
<h2>Task 7 - Create a Server SSL Profile<a class="headerlink" href="#task-7-create-a-server-ssl-profile" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Local Traffic &gt;&gt; Profiles &gt;&gt; SSL &gt;&gt; Server</strong>, then click the <strong>+</strong> (plus symbol) to create a new SSL Profile</p>
<p><img alt="image027" src="../../_images/image0276.png" /></p>
</li>
<li><p class="first">Enter <strong>server_certsso</strong> for profile name</p>
</li>
<li><p class="first">Change the Configuraiton from Basic to Advanced via the dropdown box.</p>
</li>
<li><p class="first"><strong>Check</strong> the two custom boxes next to <strong>Certificate</strong> and <strong>Key</strong></p>
</li>
<li><p class="first">Select <strong>F5CertSSO.f5lab.local.crt</strong> from the <strong>certificate</strong> dropbox box</p>
</li>
<li><p class="first">Select <strong>F5CertSSO.f5lab.local.key</strong> from the <strong>key</strong> dropdown box</p>
</li>
<li><p class="first"><strong>Check</strong> the custom box for <strong>Servername</strong>.</p>
</li>
<li><p class="first">Enter the name <strong>mtls.acme.com</strong></p>
<p><a class="reference internal" href="../../_images/02813.png"><img alt="image028" src="../../_images/02813.png" style="width: 1000px;" /></a></p>
</li>
<li><p class="first">Check the <strong>custom</strong> box about the <strong>Client Certificate Constrained Delegation</strong> box</p>
</li>
<li><p class="first">Select <strong>Enabled</strong> from the <strong>Client Certificate Constrained Delegation</strong> dropdown box</p>
</li>
<li><p class="first">Select <strong>F5SubCA.f5lab.local.crt</strong> from the <strong>CA Certificate</strong> dropdown box</p>
</li>
<li><p class="first">Select <strong>F5SubCA.f5lab.local.key</strong> from the <strong>CA Key dropdown</strong> box</p>
</li>
<li><p class="first"><strong>Click</strong> Finished</p>
<p><a class="reference internal" href="../../_images/image0297.png"><img alt="image029" src="../../_images/image0297.png" style="width: 1000px;" /></a></p>
</li>
</ol>
</div>
<div class="section" id="task-8-create-the-pool">
<h2>Task 8 - Create the Pool<a class="headerlink" href="#task-8-create-the-pool" title="Permalink to this headline">¶</a></h2>
<p>In this section you create a pool that contains the IP address of the CentOS server hosting the website requiring mTLS.</p>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Local Traffic &gt;&gt; Pools &gt;&gt; Pool List</strong>, then click the <strong>+</strong> (plus symbol) to create a new <strong>Pool</strong></p>
<p><img alt="image030" src="../../_images/image0307.png" /></p>
</li>
<li><p class="first">Enter <strong>mtls_pool</strong> for the <strong>Pool Name</strong></p>
</li>
<li><p class="first">Select <strong>https</strong> from the list of available monitors</p>
</li>
<li><p class="first">Enter <strong>10.1.20.9</strong> for the member address</p>
</li>
<li><p class="first">Enter <strong>443</strong> for the member port</p>
</li>
<li><p class="first">Click <strong>add</strong></p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
<p><a class="reference internal" href="../../_images/image0316.png"><img alt="image031" src="../../_images/image0316.png" style="width: 800px;" /></a></p>
</li>
</ol>
</div>
<div class="section" id="task-9-create-a-virtual-server">
<h2>Task 9 - Create a Virtual Server<a class="headerlink" href="#task-9-create-a-virtual-server" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Local Traffic &gt;&gt; Virtual Servers &gt;&gt; Virtual Server List</strong>, then click the <strong>+</strong> (plus symbol) to create a new virtual Server</p>
<p><img alt="image032" src="../../_images/image0326.png" /></p>
</li>
<li><p class="first">Enter <strong>mtls_vs</strong> for the <strong>Name</strong></p>
</li>
<li><p class="first">Enter <strong>10.1.10.105</strong> for the <strong>DestinationAddress/Mask</strong></p>
</li>
<li><p class="first">Enter <strong>443</strong> for the <strong>Service Port</strong></p>
</li>
<li><p class="first">Select <strong>http</strong> for <strong>HTTP Profile (Client)</strong></p>
</li>
<li><p class="first">Select <strong>client_certsso</strong> from the <strong>SSL Profile (Client)</strong> List</p>
<p><a class="reference internal" href="../../_images/image0336.png"><img alt="image033" src="../../_images/image0336.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Select <strong>server_certsso</strong> from the <strong>SSL Profile (Server)</strong> List</p>
</li>
<li><p class="first">Select <strong>Auto Map</strong> from the <strong>Source Address Translation</strong> dropdown Box</p>
</li>
<li><p class="first">Select <strong>cert_sso</strong> from the <strong>Access Profile</strong> dropdown Box</p>
<p><a class="reference internal" href="../../_images/image0345.png"><img alt="image034" src="../../_images/image0345.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Select the irule <strong>Cert_SSO</strong></p>
</li>
<li><p class="first">Select <strong>mtls_pool</strong> for the <strong>Default Pool</strong></p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The following iRule must be used when inserting custom extensions using C3D.</p>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>when SERVERSSL_CLIENTHELLO_SEND {
<span class="linenos">2</span>   set username [ACCESS::session data get &quot;session.logon.last.username&quot;]
<span class="linenos">3</span>   set domain [ACCESS::session data get &quot;session.ad.last.actualdomain&quot;]
<span class="linenos">4</span>   SSL::c3d extension 1.1.1.1 &quot;Minted Extension=$username@$domain&quot;
<span class="linenos">5</span>}
</pre></div>
</div>
<p><a class="reference internal" href="../../_images/image0354.png"><img alt="image035" src="../../_images/image0354.png" style="width: 800px;" /></a></p>
</div>
<div class="section" id="task-10-test-certsso">
<h2>Task 10 - Test CertSSO<a class="headerlink" href="#task-10-test-certsso" title="Permalink to this headline">¶</a></h2>
<p>In this section, you will test access to an NGINX website requiring mTLS.</p>
<ol class="arabic">
<li><p class="first">From the jumpbox’s web browser, access <a class="reference external" href="https://mtls.acme.com">https://mtls.acme.com</a></p>
</li>
<li><dl class="first docutils">
<dt>Use the following credentials:</dt><dd><ul class="simple">
<li>Username <strong>user1</strong></li>
<li>Password: <strong>user1</strong></li>
<li>OTP: <strong>123456</strong></li>
</ul>
</dd>
</dl>
<p><a class="reference internal" href="../../_images/image0442.png"><img alt="image044" src="../../_images/image0442.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">You will be logged into the site as <strong>User1</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The contents of the certificate used for logging into the website was the CertSSO certificate copied into Per-Session Policy. The iRule that was attached inserted the custom extension 1.1.1.1 with the value of the user’s logon name.  Notice that the Subject Name is CertSSO, the Subject Alternative Name is empty, and the custom extension is <a class="reference external" href="mailto:user1&#37;&#52;&#48;f5lab&#46;local">user1<span>&#64;</span>f5lab<span>&#46;</span>local</a>.</p>
<blockquote class="last">
<div><ul class="simple">
<li>Cert Subject: <strong>f5certsso</strong></li>
<li>Subject Alt: <strong>&lt;empty&gt;</strong></li>
<li>Custom Ext: <strong>user1&#64;f5lab.local</strong></li>
</ul>
</div></blockquote>
</div>
<p><img alt="image045" src="../../_images/image0452.png" /></p>
</li>
<li><p class="first">Open a new incognito browser window so you can test access to <a class="reference external" href="https://mtls.acme.com">https://mtls.acme.com</a> with different user credentials.</p>
<p><img alt="image048" src="../../_images/image0482.png" /></p>
</li>
<li><dl class="first docutils">
<dt>Use the following credentials:</dt><dd><ul class="simple">
<li>Username <strong>user2</strong></li>
<li>Password: <strong>user2</strong></li>
<li>OTP: <strong>123456</strong></li>
</ul>
</dd>
</dl>
<p><a class="reference internal" href="../../_images/image0501.png"><img alt="image050" src="../../_images/image0501.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">You will be logged into the site as <strong>user2&#64;f5lab.local</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Notice that user2’s Cert Subject is the same as in User1, but the custom extension name is different (now <a class="reference external" href="mailto:user2&#37;&#52;&#48;f5lab&#46;local">user2<span>&#64;</span>f5lab<span>&#46;</span>local</a>).</p>
<blockquote class="last">
<div><ul class="simple">
<li>Cert Subject: <strong>f5certsso</strong></li>
<li>Subject Alt: <strong>&lt;empty&gt;</strong></li>
<li>Custom Ext: <strong>user2&#64;f5lab.local</strong></li>
</ul>
</div></blockquote>
</div>
<p><img alt="image051" src="../../_images/image0511.png" /></p>
</li>
</ol>
</div>
<div class="section" id="task-11-create-an-http-connector-transport">
<h2>Task 11 - Create an HTTP Connector Transport<a class="headerlink" href="#task-11-create-an-http-connector-transport" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Access &gt;&gt; Authentication &gt;&gt; HTTP Connector &gt;&gt; HTTP Connector Transport</strong> and click the  <strong>+</strong> (plus symbol)</p>
<p><a class="reference internal" href="../../_images/image0541.png"><img alt="image054" src="../../_images/image0541.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Enter Name <strong>demo-http-connector</strong></p>
</li>
<li><p class="first">Select <strong>internal-dns-resolver</strong> from the <strong>DNS Resolver</strong> dropdown</p>
</li>
<li><p class="first">Select <strong>apiadmin-serverssl</strong> from the <strong>Server SSL Profile</strong></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image055" src="../../_images/image0551.png" /></p>
</li>
</ol>
</div>
<div class="section" id="task-12-create-a-http-connector-request">
<h2>Task 12 - Create a HTTP Connector Request<a class="headerlink" href="#task-12-create-a-http-connector-request" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Access &gt;&gt; Authentication &gt;&gt; HTTP Connector &gt;&gt; HTTP Connector Request</strong> and click the  <strong>+</strong> (plus symbol)</p>
<p><img alt="image056" src="../../_images/image0561.png" /></p>
</li>
<li><p class="first">Enter name <strong>get-cert</strong></p>
</li>
<li><p class="first">Select <strong>demo-http-connector</strong> from the dropdown</p>
</li>
<li><p class="first">Enter URL <strong>https://adapi.f5lab.local:8443/user/cert?username=%{perflow.username}</strong></p>
</li>
<li><p class="first">Enter <strong>GET</strong> for the <strong>Method</strong></p>
</li>
<li><p class="first">Select <strong>Parse</strong> for the <strong>Response Action</strong></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image057" src="../../_images/image0571.png" /></p>
</li>
</ol>
</div>
<div class="section" id="task-13-create-a-per-request-policy">
<h2>Task 13 - Create a Per-Request Policy<a class="headerlink" href="#task-13-create-a-per-request-policy" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Access &gt;&gt; Profiles/Policies &gt;&gt; Per-Request Policies</strong> and click the  <strong>+</strong> (plus symbol)</p>
<p><img alt="image058" src="../../_images/image0581.png" /></p>
</li>
<li><p class="first">Enter the name <strong>certsso_prp</strong></p>
</li>
<li><p class="first">Select the Language <strong>English</strong></p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
<p><a class="reference internal" href="../../_images/image0591.png"><img alt="image059" src="../../_images/image0591.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Click <strong>edit</strong> under <strong>Per-Request Policy</strong></p>
<p><a class="reference internal" href="../../_images/image060.png"><img alt="image060" src="../../_images/image060.png" style="width: 1000px;" /></a></p>
</li>
<li><p class="first">Click <strong>Add New Subroutine</strong></p>
<p><img alt="image061" src="../../_images/image061.png" /></p>
</li>
<li><p class="first">Enter the name <strong>Request Cert</strong></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image062" src="../../_images/image062.png" /></p>
</li>
<li><p class="first">Expand the subroutine by click the <strong>+</strong> (plus symbol)</p>
<p><img alt="image063" src="../../_images/image063.png" /></p>
</li>
<li><p class="first">Click the <strong>+</strong> (plus symbol) on the fallback branch.</p>
<p><img alt="image064" src="../../_images/image064.png" /></p>
</li>
<li><p class="first">Click the <strong>General Purpose</strong> tab</p>
</li>
<li><p class="first">Select <strong>HTTP Connector</strong></p>
</li>
<li><p class="first">Click <strong>Add Item</strong></p>
<p><img alt="image065" src="../../_images/image065.png" /></p>
</li>
<li><p class="first">Select <strong>get-cert</strong> drop the dropdown</p>
<p><img alt="image066" src="../../_images/image066.png" /></p>
</li>
<li><p class="first">Click <strong>Edit Terminals</strong></p>
<p><img alt="image067" src="../../_images/image067.png" /></p>
</li>
<li><p class="first">Click <strong>Add Terminal</strong></p>
<p><img alt="image068" src="../../_images/image068.png" /></p>
</li>
<li><p class="first">Change the name for the default branch to <strong>Fail</strong></p>
</li>
<li><p class="first">Change the default branch text to <strong>Red</strong></p>
</li>
<li><p class="first">Enter the name <strong>Success</strong> for the new branch</p>
</li>
<li><p class="first">Change the color of the new branch to <strong>Green</strong></p>
<p><img alt="image069" src="../../_images/image069.png" /></p>
</li>
<li><p class="first">Click the <strong>Fail</strong> terminal at the end of the <strong>Successful</strong> branch</p>
<p><img alt="image070" src="../../_images/image070.png" /></p>
</li>
<li><p class="first">Select the <strong>Success</strong> terminal</p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image071" src="../../_images/image071.png" /></p>
</li>
<li><p class="first">Click the <strong>+</strong> (plus symbol) on the <strong>successful</strong> branch</p>
<p><img alt="image072" src="../../_images/image072.png" /></p>
</li>
<li><p class="first">Click the <strong>Assignment</strong> tab</p>
</li>
<li><p class="first">Select <strong>Variable Assign</strong></p>
</li>
<li><p class="first">Click <strong>Add Item</strong></p>
<p><img alt="image073" src="../../_images/image073.png" /></p>
</li>
<li><p class="first">Click <strong>Add new entry</strong></p>
</li>
<li><p class="first">Click <strong>change</strong></p>
<p><img alt="image074" src="../../_images/image074.png" /></p>
</li>
<li><p class="first">Enter <strong>session.ssl.cert.whole</strong> for the <strong>Custom Variable</strong></p>
</li>
<li><p class="first">Select <strong>Session Variable</strong> from the dropdown</p>
</li>
<li><p class="first">Enter <strong>subsession.http_connector.body.certificate</strong> for the <strong>Session Variable</strong></p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
<p><img alt="image075" src="../../_images/image075.png" /></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image076" src="../../_images/image076.png" /></p>
</li>
<li><p class="first">Click the <strong>+</strong> (plus symbol) located between <strong>Start</strong> and <strong>Allow</strong> in the policy</p>
<p><img alt="image077" src="../../_images/image077.png" /></p>
</li>
<li><p class="first">Click the <strong>Subroutines</strong> tab</p>
</li>
<li><p class="first">Select the <strong>Request Cert</strong> subroutine</p>
</li>
<li><p class="first">Click <strong>Add Item</strong></p>
<p><img alt="image078" src="../../_images/image078.png" /></p>
</li>
<li><p class="first">Click the <strong>+</strong> (plus symbol) on the success branch of <strong>Request Cert</strong></p>
<p><img alt="image079" src="../../_images/image079.png" /></p>
</li>
<li><p class="first">Click the <strong>General Purpose</strong> tab</p>
</li>
<li><p class="first">Select <strong>irule Event</strong></p>
</li>
<li><p class="first">Click <strong>Add Item</strong></p>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This iRule event triggers the code from the previously attached iRule. This iRule must be used when inserting a certificate using C3D in a per-request policy.</p>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>when ACCESS_PER_REQUEST_AGENT_EVENT {
<span class="linenos">2</span>   set cert [ACCESS::session data get {session.ssl.cert.whole}]
<span class="linenos">3</span>   log local0. &quot;My cert: $cert&quot;
<span class="linenos">4</span>   SSL::c3d cert [X509::pem2der $cert]
<span class="linenos">5</span>}
<span class="linenos">6</span>
<span class="linenos">7</span>
<span class="linenos">8</span>|image080|
</pre></div>
</div>
<ol class="arabic">
<li><p class="first">Enter <strong>lab</strong> for the <strong>ID</strong></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image081" src="../../_images/image081.png" /></p>
</li>
</ol>
</div>
<div class="section" id="task-14-attach-the-prp-to-the-mtls-virtual-server">
<h2>Task 14 - Attach the PRP to the mTLS Virtual Server<a class="headerlink" href="#task-14-attach-the-prp-to-the-mtls-virtual-server" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Local Traffic &gt;&gt; Virtual Servers</strong>.  Click <strong>Virtual Server List</strong></p>
<p><img alt="image082" src="../../_images/image082.png" /></p>
</li>
<li><p class="first">Click <strong>mtls_vs</strong></p>
<p><img alt="image083" src="../../_images/image083.png" /></p>
</li>
<li><p class="first">Navigate to the <strong>Access Policy</strong> section and select <strong>certsso_prp</strong> from the <strong>Per-Request Policy</strong> dropdown</p>
</li>
<li><p class="first">Click <strong>Update</strong></p>
<p><img alt="image084" src="../../_images/image084.png" /></p>
</li>
</ol>
<div class="section" id="task-15-access-mtls-acme-com-with-dynamic-certificate">
<h3>Task 15 - Access mtls.acme.com with Dynamic Certificate<a class="headerlink" href="#task-15-access-mtls-acme-com-with-dynamic-certificate" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">From the web browser on the jumphost, access <a class="reference external" href="https://mtls.acme.com">https://mtls.acme.com</a></p>
</li>
<li><p class="first">Use the following credentials:
- Username: <strong>user1</strong>
- password: <strong>user1</strong>
- OTP: <strong>123456</strong></p>
<p><a class="reference internal" href="../../_images/image0442.png"><img alt="image044" src="../../_images/image0442.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">You will be logged into the site as <strong>user1&#64;f5lab.local</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<blockquote>
<div><p>The contents of the certificate used for logging into the website were from certificate retrieved via HTTP connector in Active Directory. The irule continues to insert the     custom extension 1.1.1.1 with the value containing the user’s logon name. Notice the Subject Name is user1, the Subject Alternative Name is <a class="reference external" href="mailto:user1&#37;&#52;&#48;f5lab&#46;local">user1<span>&#64;</span>f5lab<span>&#46;</span>local</a> and the custom    extension is <a class="reference external" href="mailto:user1&#37;&#52;&#48;f5lab&#46;local">user1<span>&#64;</span>f5lab<span>&#46;</span>local</a></p>
</div></blockquote>
<ul class="last simple">
<li>Cert Subject: <strong>user1</strong></li>
<li>Subject Alt: <strong>user1&#64;f5lab.local</strong></li>
<li>Custom Ext: <strong>user1&#64;f5lab.local</strong></li>
</ul>
</div>
<p><img alt="image085" src="../../_images/image085.png" /></p>
</li>
<li><p class="first">Open a new incognito browser window so you can test access to mtls.acme.com with different user credentials.</p>
<p><img alt="image048" src="../../_images/image0482.png" /></p>
</li>
<li><p class="first">Use the following credentials:</p>
<ul class="simple">
<li>Username: <strong>user1</strong></li>
<li>password: <strong>user1</strong></li>
<li>OTP: <strong>123456</strong></li>
</ul>
<p><a class="reference internal" href="../../_images/image0501.png"><img alt="image050" src="../../_images/image0501.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">You will be logged into the site as <strong>user2&#64;f5lab.local</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Notice that user2’s Cert Subject is now user2 and the subject alt is <a class="reference external" href="mailto:user2&#37;&#52;&#48;f5lab&#46;local">user2<span>&#64;</span>f5lab<span>&#46;</span>local</a>.  The irule continues to insert the custom extension.</p>
<blockquote class="last">
<div><ul class="simple">
<li>Subject: <strong>user2</strong></li>
<li>Subject Alt: <strong>user2&#64;f5lab.local</strong></li>
<li>Custom Ext: <strong>user2&#64;f5lab.local</strong></li>
</ul>
</div></blockquote>
</div>
<p><img alt="image086" src="../../_images/image086.png" /></p>
</li>
</ol>
<p>This concludes our lab on APM C3D Enchancements</p>
<blockquote>
<div><img alt="image000" src="../../_images/00021.png" /></div></blockquote>
</div>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="intro.html" title="Environment Overview" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="lab02.html" title="Lab 2: Implement Priviledged User Access Authentication" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>