<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>Lab 2: Additional Security - Bot Defense and WAF</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="Lab 2: Additional Security - Bot Defense and WAF"/>
  <meta name="product" content="F5 Identity and Access Management Solutions"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2021-06-21 13:23:29"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 Identity and Access Management Solutions" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab 2: Additional Security - Bot Defense and WAF &#8212; F5 Identity and Access Management Solutions  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/CoveoFullSearch.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/21fb8a09c3.css" type="text/css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Environment Overview" href="../module5/intro.html" />
    <link rel="prev" title="Lab 1: Deploy an API Protection Profile" href="lab01.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 Identity and Access Management Solutions  </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../class1/class1.html">100 Series: Access Foundational Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class2/class2.html">200 Series: Assisted Deployment Use Cases</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../class3.html">300 Series: Advanced Use Cases &amp; Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class4/class4.html">400 Series: Access Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class5/class5.html">500 Series: Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archived/archived.html">Archived Identity &amp; Access Management Labs</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">Lab 2: Additional Security - Bot Defense and WAF</a><ul>
<li><a class="reference internal" href="#section-2-1-setup-lab-environment">Section 2.1 - Setup Lab Environment</a><ul>
<li><a class="reference internal" href="#task-1-import-postman-collection">Task 1 - Import Postman Collection</a></li>
<li><a class="reference internal" href="#task-2-add-vulnerable-api">Task 2 - Add Vulnerable API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#section-2-2-create-and-assign-profiles">Section 2.2 - Create and Assign Profiles</a><ul>
<li><a class="reference internal" href="#task-1-create-and-assign-a-security-logging-profile-to-the-virtual">Task 1 - Create and assign a Security Logging Profile to the virtual</a></li>
<li><a class="reference internal" href="#task-2-set-the-waf-policy-to-transparent-and-assign-it-to-the-virtual">Task 2 - Set the WAF policy to Transparent and assign it to the virtual</a></li>
<li><a class="reference internal" href="#task-3-create-and-assign-a-bot-defense-profile">Task 3 - Create and assign a Bot Defense Profile</a></li>
</ul>
</li>
<li><a class="reference internal" href="#section-2-3-test-bot-protection">Section 2.3 - Test Bot Protection</a><ul>
<li><a class="reference internal" href="#task-1-test-bot-protection-in-transparent-mode">Task 1 - Test Bot Protection in Transparent Mode</a></li>
<li><a class="reference internal" href="#task-2-place-bot-profile-in-blocking-and-allow-appropriate-clients">Task 2 - Place Bot Profile in blocking and allow appropriate clients</a></li>
</ul>
</li>
<li><a class="reference internal" href="#section-2-4-layer-on-waf-to-provide-additional-security">Section 2.4 - Layer on WAF to provide additional security</a><ul>
<li><a class="reference internal" href="#task-1-configure-attack-signatures-and-change-waf-policy-to-blocking">Task 1 - Configure Attack Signatures and Change WAF Policy to Blocking</a></li>
<li><a class="reference internal" href="#task-2-implement-static-parameter-values">Task 2 - Implement Static Parameter values</a></li>
</ul>
</li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">F5 Identity and Access Management Solutions</a>
              &gt; <a href="../class3.html">300 Series: Advanced Use Cases &amp; Solutions</a>

          <span class="right">
             <a href="../../_sources/class3/module4/lab02.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/f5devcentral/f5-agility-labs-iam">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="lab-2-additional-security-bot-defense-and-waf">
<h1>Lab 2: Additional Security - Bot Defense and WAF<a class="headerlink" href="#lab-2-additional-security-bot-defense-and-waf" title="Permalink to this headline">¶</a></h1>
<p>The API protection profile provides authorization and basic WAF policy to protect an API. This module will demonstrate how to layer on additional protections to further validate what is accessing the API and that the client is behaving within the norms of the API.</p>
<div class="section" id="section-2-1-setup-lab-environment">
<h2>Section 2.1 - Setup Lab Environment<a class="headerlink" href="#section-2-1-setup-lab-environment" title="Permalink to this headline">¶</a></h2>
<p>By default, security events are not logged, in this lab the student will create a security logging profile with Application Security, Bot Defense and DOS Protection enabled.
The student will also place the waf policy in trasnparent to show the difference in behavior when client traffic that is deemed malicious is and is not blocked.</p>
<div class="section" id="task-1-import-postman-collection">
<h3>Task 1 - Import Postman Collection<a class="headerlink" href="#task-1-import-postman-collection" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">From the Jumpbox, open <strong>Postman</strong> via the desktop shortcut or toolbar at the bottom</p>
<blockquote>
<div><p><img alt="image001" src="../../_images/00115.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Yes</strong> if prompted for “Do you want to allow this app to make changes to your device?”</p>
<blockquote>
<div><p><img alt="image002" src="../../_images/00216.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Import</strong> located on the top left of the Postman application</p>
<blockquote>
<div><p><img alt="image003" src="../../_images/00315.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Upload Files</strong></p>
<p><img alt="image004" src="../../_images/00416.png" /></p>
</li>
<li><p class="first">Navigate to C:\access-labs\class3\module4\student_files, select <strong>student-class3-module4-lab02.postman_collection.json</strong>, and click <strong>Open</strong></p>
<blockquote>
<div><p><img alt="image005" src="../../_images/00516.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Import</strong></p>
<p><img alt="image006" src="../../_images/00615.png" /></p>
</li>
<li><p class="first">A collection called <strong>student-class3-module4-lab02</strong> will appear on the left side in Postman</p>
</li>
</ol>
</div>
<div class="section" id="task-2-add-vulnerable-api">
<h3>Task 2 - Add Vulnerable API<a class="headerlink" href="#task-2-add-vulnerable-api" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ensure you are logged into BIGIP1</p>
</div>
<ol class="arabic">
<li><p class="first">From the web browser, navigate to Access &gt;&gt; API Protection &gt;&gt; Profile.  Click <strong>Profile</strong> to modify the existing profile <strong>api-protection</strong> Profile (not the + Plus symbol)</p>
<p><img alt="image48" src="../../_images/image0485.png" /></p>
</li>
<li><p class="first">Click <strong>Edit</strong> Under Per-Request Policy</p>
<p><img alt="image49" src="../../_images/0497.png" /></p>
</li>
<li><p class="first">Click the <strong>+ (Plus Symbol)</strong> located between Start and OAuth Scope Check AuthZ</p>
<p><a class="reference internal" href="../../_images/1011.png"><img alt="image101" src="../../_images/1011.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Select the <strong>Classification</strong> tab</p>
</li>
<li><p class="first">Select <strong>Request Classification</strong></p>
</li>
<li><p class="first">Click <strong>Add Item</strong></p>
<p><a class="reference internal" href="../../_images/image1023.png"><img alt="image102" src="../../_images/image1023.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Select <strong>Branch Rules</strong></p>
</li>
<li><p class="first">Click <strong>Add Branch Rule</strong></p>
</li>
<li><p class="first">Enter name <strong>GET /vulnerable</strong></p>
</li>
<li><p class="first">Click <strong>Change</strong></p>
<p><img alt="image103" src="../../_images/image1034.png" /></p>
</li>
<li><p class="first">Click <strong>Add Expression</strong></p>
<p><img alt="image104" src="../../_images/image1043.png" /></p>
</li>
<li><p class="first">Select <strong>Request</strong> from the Context dropdown</p>
</li>
<li><p class="first">Click <strong>Add Expression</strong></p>
<p><img alt="image105" src="../../_images/image1053.png" /></p>
</li>
<li><p class="first">Click <strong>Add Expression</strong> on the AND line</p>
<p><img alt="image106" src="../../_images/image1063.png" /></p>
</li>
<li><p class="first">Select <strong>Path (value)</strong> from the Request dropdown</p>
</li>
<li><p class="first">Enter <strong>/vulnerable</strong> in the empty text box</p>
</li>
<li><p class="first">Click <strong>Add Expression</strong></p>
<p><img alt="image107" src="../../_images/image1073.png" /></p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
<p><img alt="image108" src="../../_images/image1083.png" /></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image109" src="../../_images/image1093.png" /></p>
</li>
<li><p class="first">Click the <strong>+ Plus Symbol</strong> on the GET /vulnerable branch</p>
<p><img alt="image110" src="../../_images/1101.png" /></p>
</li>
<li><p class="first">Click <strong>API Server Selection</strong></p>
</li>
<li><p class="first">Click <strong>Add Item</strong></p>
<p><img alt="image111" src="../../_images/image1114.png" /></p>
</li>
<li><p class="first">Select <strong>api-protection_server1</strong> from the dropdown</p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image112" src="../../_images/image1123.png" /></p>
</li>
<li><p class="first">Click the <strong>Reject</strong> terminal at the end of API Server Selection</p>
<p><a class="reference internal" href="../../_images/1131.png"><img alt="image113" src="../../_images/1131.png" style="width: 1200px;" /></a></p>
</li>
<li><p class="first">Select <strong>Allow</strong></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p><img alt="image114" src="../../_images/image1143.png" /></p>
</li>
<li><p class="first">The completed policy should look like the below.</p>
<p><a class="reference internal" href="../../_images/115.png"><img alt="image115" src="../../_images/115.png" style="width: 1200px;" /></a></p>
</li>
</ol>
</div>
</div>
<div class="section" id="section-2-2-create-and-assign-profiles">
<h2>Section 2.2 - Create and Assign Profiles<a class="headerlink" href="#section-2-2-create-and-assign-profiles" title="Permalink to this headline">¶</a></h2>
<div class="section" id="task-1-create-and-assign-a-security-logging-profile-to-the-virtual">
<h3>Task 1 - Create and assign a Security Logging Profile to the virtual<a class="headerlink" href="#task-1-create-and-assign-a-security-logging-profile-to-the-virtual" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">From the web browser, click on the <strong>Security -&gt; Event Logs -&gt; Logging Profile</strong> and click <strong>Create</strong>.</p>
</li>
<li><p class="first">For the Profile Name enter <strong>api.acme.com_logprofile</strong>.</p>
<p><img alt="module2Lab1Task2-image1" src="../../_images/module2Lab1Task1-image1.png" /></p>
</li>
<li><p class="first">Enable <strong>Application Security</strong>, an Application Security configuration menu will open up at the bottom. Change the Request Type from Illegal requests only to <strong>All requests</strong>.</p>
<p><a class="reference internal" href="../../_images/module2Lab1Task1-image2.png"><img alt="module2Lab1Task2-image2" src="../../_images/module2Lab1Task1-image2.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Enable <strong>DoS Protection</strong>, a DoS Protection configuration menu will open up at the bottom. Enable <strong>Local Publisher</strong></p>
<p><a class="reference internal" href="../../_images/module2Lab1Task1-image3.png"><img alt="module2Lab1Task2-image3" src="../../_images/module2Lab1Task1-image3.png" style="width: 400px;" /></a></p>
</li>
<li><p class="first">Enable <strong>Bot Defense</strong>, a Bot Defense configuration menu will open up at the bottom. Enable <strong>Local Publisher</strong> and all other checkboxes, leave Remote Publisher set to none.</p>
<p><a class="reference internal" href="../../_images/module2Lab1Task1-image4.png"><img alt="module2Lab1Task2-image4" src="../../_images/module2Lab1Task1-image4.png" style="width: 400px;" /></a></p>
</li>
<li><p class="first">Click <strong>Create</strong></p>
</li>
<li><p class="first">Apply the log profile to the api.acme.com virtual by navigating to <strong>Local Traffic -&gt; Virtual Servers -&gt; api.acme.com -&gt; Security -&gt; Policies</strong> and after choosing “Enabled” from the dropdown, set the Selected Log Profile to <strong>api.acme.com_logprofile</strong>.</p>
<p><a class="reference internal" href="../../_images/module2Lab1Task1-image5.png"><img alt="module2Lab1Task2-image5" src="../../_images/module2Lab1Task1-image5.png" style="width: 400px;" /></a></p>
</li>
<li><p class="first">Click <strong>Update</strong>. The virtual will now log Application Security, DoS and Bot related events under <strong>Security -&gt; Event Logs</strong> when an appropriate security profiles have been applied to the virtual.</p>
</li>
</ol>
</div>
<div class="section" id="task-2-set-the-waf-policy-to-transparent-and-assign-it-to-the-virtual">
<h3>Task 2 - Set the WAF policy to Transparent and assign it to the virtual<a class="headerlink" href="#task-2-set-the-waf-policy-to-transparent-and-assign-it-to-the-virtual" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">From the web browser, click on the Security -&gt; Application Security -&gt; Security Policies -&gt; Policies List. Click  <strong>api-protection</strong>. Scroll down and you’ll notice the Enforcement Mode is set to <strong>Blocking</strong>. Set the Enforcement Mode to <strong>Transparent</strong>. Be sure to click <strong>Save</strong>, then <strong>Apply Policy</strong>.</p>
<p><a class="reference internal" href="../../_images/module2Lab1Task3-image1.png"><img alt="module2Lab1Task3-image1" src="../../_images/module2Lab1Task3-image1.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Apply the waf policy to the api.acme.com virtual by navigating to <strong>Local Traffic -&gt; Virtual Servers -&gt; api.acme.com -&gt; Security -&gt; Policies</strong> and set the Application Security Policy to enabled and the Policy to  <strong>api-protection</strong>.</p>
<p><a class="reference internal" href="../../_images/module2Lab1Task3-image2.png"><img alt="module2Lab1Task3-image2" src="../../_images/module2Lab1Task3-image2.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Click <strong>Update</strong>.</p>
</li>
</ol>
</div>
<div class="section" id="task-3-create-and-assign-a-bot-defense-profile">
<h3>Task 3 - Create and assign a Bot Defense Profile<a class="headerlink" href="#task-3-create-and-assign-a-bot-defense-profile" title="Permalink to this headline">¶</a></h3>
<p>An api’s clients, unlike a typical web application, will often be non-human, maybe even exclusively.
This leaves bot defense more difficult to configure in an api protection scenario, for instance javascript such as captcha cannot be used to proactively determine whether the client is human.
In this lab, we demonstrate some scenarios the admin may encounter and how to address them.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ensure you are logged into BIGIP1</p>
</div>
<ol class="arabic">
<li><p class="first">From the web browser, click on the <strong>Security -&gt; Bot Defense -&gt; Bot Defense Profiles</strong> and click <strong>Create</strong>.</p>
</li>
<li><p class="first">For the name enter <strong>api.acme.com_botprofile</strong>, leave all other settings at their defaults.</p>
<p><a class="reference internal" href="../../_images/module2Lab2Task1-image1.png"><img alt="module2Lab2Task1-image1" src="../../_images/module2Lab2Task1-image1.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<p>The bot profile is left in transparent mode to demonstrate the logging behavior and behavior differences to the client.</p>
</li>
<li><p class="first">Apply the bot profile to the api.acme.com virtual by navigating to <strong>Local Traffic -&gt; Virtual Servers -&gt; api.acme.com -&gt; Security -&gt; Policies</strong>.</p>
</li>
</ol>
<p>For <strong>Bot Defense Profile</strong> select <strong>Enabled</strong> and select <strong>api.acme.com_botprofile</strong> as the Profile. Click <strong>Update</strong>.</p>
<blockquote>
<div><a class="reference internal" href="../../_images/module2Lab2Task1-image2.png"><img alt="module2Lab2Task1-image2" src="../../_images/module2Lab2Task1-image2.png" style="width: 800px;" /></a></div></blockquote>
</div>
</div>
<div class="section" id="section-2-3-test-bot-protection">
<h2>Section 2.3 - Test Bot Protection<a class="headerlink" href="#section-2-3-test-bot-protection" title="Permalink to this headline">¶</a></h2>
<div class="section" id="task-1-test-bot-protection-in-transparent-mode">
<h3>Task 1 - Test Bot Protection in Transparent Mode<a class="headerlink" href="#task-1-test-bot-protection-in-transparent-mode" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Now we will test the Bot Defense Profile to see how it affects clients. Go to <strong>Postman</strong>, expand the collection <strong>student-class3-module4-lab02</strong> and select the request <strong>Request 1: Retrieve Attributes</strong> and click <strong>Send</strong>.</p>
</li>
<li><p class="first">Return to the bigip01 gui and navigate to <strong>Security -&gt; Event Logs -&gt; Bot Defense -&gt; Bot Requests</strong> and find the request to the /vulnerable uri as shown below</p>
<p><a class="reference internal" href="../../_images/module2Lab2Task1-image4.png"><img alt="module2Lab2Task1-image4" src="../../_images/module2Lab2Task1-image4.png" style="width: 800px;" /></a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The student should pay special attention to the Request Status, Mitigation Action and Bot Class. Bot Class will be one of the categories found in <strong>Security -&gt; Bot Defense -&gt; Bot Defense Profiles -&gt; api.acme.com_botprofile -&gt; Bot Mitigation Settings</strong> under <strong>Mitigation Settings</strong>.</p>
</div>
</li>
</ol>
</div>
<div class="section" id="task-2-place-bot-profile-in-blocking-and-allow-appropriate-clients">
<h3>Task 2 - Place Bot Profile in blocking and allow appropriate clients<a class="headerlink" href="#task-2-place-bot-profile-in-blocking-and-allow-appropriate-clients" title="Permalink to this headline">¶</a></h3>
<p>The bot profile was left in transparent to demonstrate the behavior, now we will configure the bot profile to
block bot traffic. Keep in mind that the bot profile allows for fine-grained control of categories of bots, which bot fits in those categories. We will explore this later.</p>
<ol class="arabic">
<li><p class="first">Navigate back to <strong>Security -&gt; Bot Defense -&gt; Bot Defense Profiles -&gt; api.acme.com_botprofile</strong>, change the <strong>Enforcement Mode</strong> to  <strong>Blocking</strong> and click <strong>Save</strong>.</p>
<p><a class="reference internal" href="../../_images/module2Lab2Task2-image1.png"><img alt="module2Lab2Task2-image1" src="../../_images/module2Lab2Task2-image1.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Go back to <strong>Postman</strong> once again and select the request <strong>Request 1: Retrieve Attributes</strong> and click <strong>Send</strong> another time.</p>
</li>
<li><p class="first">Return to the bigip01 gui and navigate to <strong>Security -&gt; Event Logs -&gt; Bot Defense -&gt; Bot Requests</strong> and find the 2nd request to the /vulnerable uri as shown below</p>
</li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/module2Lab2Task2-image3.png"><img alt="module2Lab2Task2-image3" src="../../_images/module2Lab2Task2-image3.png" style="width: 800px;" /></a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Why was this request not blocked? To understand this, we must take a closer look at the Mitigation Settings.</p>
</div>
</div></blockquote>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Security -&gt; Bot Defense -&gt; Bot Defense Profiles -&gt; api.acme.com_botprofile -&gt; Bot Mitigation Settings</strong> and examine the <strong>Unknown</strong> categorization, note that bots that are of category Unknown are simply rate limited.</p>
<p><a class="reference internal" href="../../_images/module2Lab2Task2-image4.png"><img alt="module2Lab2Task2-image4" src="../../_images/module2Lab2Task2-image4.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Go back to <strong>Postman</strong> once again, click on the <strong>Arrow</strong> in the right corner of the collection <strong>student-class3-module4-lab02</strong> collection to open <strong>Runner</strong>.</p>
<p><img alt="image007" src="../../_images/00716.png" /></p>
</li>
<li><p class="first">Click Run</p>
</li>
<li><p class="first">Configure Runner so  <strong>iterations</strong> is set to <strong>100</strong> and the only request selected is  <strong>Request 1: Retrieve Attributes</strong>.</p>
</li>
<li><p class="first">Click <strong>Run student-class…</strong>.</p>
<p><img alt="image008" src="../../_images/00815.png" /></p>
</li>
<li><p class="first">Notice all responses are 200 OKs.</p>
<p><img alt="image009" src="../../_images/00915.png" /></p>
</li>
<li><p class="first">Return to the bigip01 gui and navigate to <strong>Security -&gt; Event Logs -&gt; Bot Defense -&gt; Bot Requests</strong> and find the Denied request to the /vulnerable uri as shown below.</p>
<p><a class="reference internal" href="../../_images/module2Lab2Task2-image7.png"><img alt="module2Lab2Task2-image7" src="../../_images/module2Lab2Task2-image7.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">We will recategorize the Postman client so that it is a trusted client, this is done via bot signatures. Navigate to <strong>Security -&gt; Bot Defense -&gt; Bot Signatures -&gt; Bot Signatures Categories List</strong> and click <strong>Create</strong>.</p>
</li>
<li><p class="first">Fill in the Bot Signature Category Name of <strong>Trusted Development Tools</strong> and select <strong>Trusted Bot</strong> from the Bot Class dropdown.</p>
<p><a class="reference internal" href="../../_images/module2Lab2Task2-image12.png"><img alt="module2Lab2Task2-image12" src="../../_images/module2Lab2Task2-image12.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Navigate to <strong>Security -&gt; Bot Defense -&gt; Bot Signatures -&gt; Bot Signatures List</strong> and click <strong>Create</strong>.</p>
<p><a class="reference internal" href="../../_images/module2Lab2Task2-image8.png"><img alt="module2Lab2Task2-image8" src="../../_images/module2Lab2Task2-image8.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Fill in the Bot Name, Bot Category and Rule (User Agent) with the following, leaving all other values at their defaults.</p>
<p><a class="reference internal" href="../../_images/module2Lab2Task2-image9.png"><img alt="module2Lab2Task2-image9" src="../../_images/module2Lab2Task2-image9.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Click <strong>Save</strong>.</p>
</li>
<li><p class="first">Go back to Postman once again and select the request <strong>Request 1: Retrieve Attributes</strong> and click <strong>Send</strong> another time. Note this is done at the main Postman window, not in Runner.</p>
</li>
<li><p class="first">Navigate to <strong>Security -&gt; Event Logs -&gt; Bot Defense -&gt; Bot Requests</strong> and find the Trusted Bot categorized request to the /vulnerable uri as shown below</p>
<p><a class="reference internal" href="../../_images/module2Lab2Task2-image11.png"><img alt="module2Lab2Task2-image11" src="../../_images/module2Lab2Task2-image11.png" style="width: 800px;" /></a></p>
</li>
</ol>
</div>
</div>
<div class="section" id="section-2-4-layer-on-waf-to-provide-additional-security">
<h2>Section 2.4 - Layer on WAF to provide additional security<a class="headerlink" href="#section-2-4-layer-on-waf-to-provide-additional-security" title="Permalink to this headline">¶</a></h2>
<p>APIs are a collection of technologies just like any other application, in the lab the api is built on top of a windows server using powershell. This lab demonstrate how to tune the WAF policy to use attack signatures and meta-character enforcement to provide additional protection against malicious clients.</p>
<p>Meta-character enforcement allows the WAF admin to enforce which characters are allowed into a web application, whether it be in the header, url or parameter. In this lab we examine parameter meta-character enforcement.</p>
<div class="section" id="task-1-configure-attack-signatures-and-change-waf-policy-to-blocking">
<h3>Task 1 - Configure Attack Signatures and Change WAF Policy to Blocking<a class="headerlink" href="#task-1-configure-attack-signatures-and-change-waf-policy-to-blocking" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Open a command prompt on the jumphost (a shortcut is on the desktop)</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image2.png"><img alt="module2Lab3Task1-image2" src="../../_images/module2Lab3Task1-image2.png" style="width: 100px;" /></a></p>
</li>
<li><p class="first">Run the following command <strong>curl -k “https://api.acme.com/vulnerable?Inject=|powershell%20badprogram.ps1” -v</strong></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Pay special attention to the double quotes (“”) around the url.</p>
</div>
</div></blockquote>
</li>
<li><p class="first">Navigate to <strong>Security -&gt; Event Logs -&gt; Application -&gt; Requests</strong> and find this latest request. Locate the parameter value <strong>|powershell badprogram.ps1</strong>. Click the parameter and then hover over the parameter value and additional details will describe this part of the attack.</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image3.png"><img alt="module2Lab3Task1-image3" src="../../_images/module2Lab3Task1-image3.png" style="width: 800px;" /></a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The <strong>Enforcement Action</strong> is None</p>
<p class="last">The F5 WAF highlights the part of the request it detects as malicious based on the policy’s configuration. This can be very useful for learning and troubleshooting purposes.</p>
</div>
</li>
<li><p class="first">Next hover over the <strong>User-Agent</strong> portion of the request.</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image4.png"><img alt="module2Lab3Task1-image4" src="../../_images/module2Lab3Task1-image4.png" style="width: 400px;" /></a></p>
<blockquote>
<div><p>Notice the user-agent is curl, which may be a legitimate client. Make note of this.</p>
<p>Ideally we want to block any malicious request, in this case the powershell execution attempt, but want to allow curl as it’s a legitimate client in our case. What about the %20 meta character, should it be allowed? Depending on the application, this could be legitimate.</p>
<p>In your environment, you must decide what is legitimate and what is illegitimate traffic, the F5 WAF can guide you via learning and help eliminate noise using Bot Defense, however to increase security beyond a basic WAF policy, understanding the application is needed.</p>
</div></blockquote>
</li>
<li><p class="first">Click on the  <strong>Security -&gt; Application Security -&gt; Policy Building -&gt; Learning and Blocking Settings -&gt; Attack Signatures</strong> and click Change</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image5.png"><img alt="module2Lab3Task1-image5" src="../../_images/module2Lab3Task1-image5.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Enable <strong>Command Execution Signatures</strong> and click <strong>Change</strong></p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image6.png"><img alt="module2Lab3Task1-image6" src="../../_images/module2Lab3Task1-image6.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Scroll to the bottom anc click <strong>Save</strong>.</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image7.png"><img alt="module2Lab3Task1-image7" src="../../_images/module2Lab3Task1-image7.png" style="width: 200px;" /></a></p>
</li>
<li><p class="first">Navigate to Security -&gt; Application Security -&gt; Security Policies -&gt; <strong>Policies List</strong>.</p>
</li>
<li><p class="first">Click  <strong>api-protection</strong></p>
</li>
<li><p class="first">Click <strong>Attack Signatures</strong></p>
</li>
<li><p class="first">Click the filter icon to easily locate the <strong>Automated client access “curl”</strong> signature.</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image8.png"><img alt="module2Lab3Task1-image8" src="../../_images/module2Lab3Task1-image8.png" style="width: 100px;" /></a></p>
</li>
<li><p class="first">For the Attack Signature Name enter <strong>Automated client access “curl”</strong> and click <strong>Apply Filter</strong>.</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image9.png"><img alt="module2Lab3Task1-image9" src="../../_images/module2Lab3Task1-image9.png" style="width: 800px;" /></a></p>
<p>The result is</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image10.png"><img alt="module2Lab3Task1-image10" src="../../_images/module2Lab3Task1-image10.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Select this signature and click <strong>Disable</strong></p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image11.png"><img alt="module2Lab3Task1-image11" src="../../_images/module2Lab3Task1-image11.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Click <strong>General Settings</strong> and scroll down to “Enforcement Mode” and change it to “Blocking.” Click Save and then Apply the Policy</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image12.png"><img alt="module2Lab3Task1-image12" src="../../_images/module2Lab3Task1-image12.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Once again run the following command <strong>curl -k “https://api.acme.com/vulnerable?Inject=|powershell%20badprogram.ps1” -v</strong></p>
<p><strong>Pay special attention to the double quotes (“”) around the url.</strong></p>
</li>
<li><p class="first">Navigate to <strong>Security -&gt; Event Logs -&gt; Application -&gt; Requests</strong> and find this latest request.</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image13.png"><img alt="module2Lab3Task1-image13" src="../../_images/module2Lab3Task1-image13.png" style="width: 800px;" /></a></p>
<p>Notice the enforcement action is still <strong>None</strong> but also notice the user-agent curl is no longer highlighted (since the signature was disabled). We changed the Policy to Blocking so why wasn’t the request blocked? Hint: Click the “1” under Occurrences and you’ll see the current status of the Attack Signature.</p>
</li>
<li><p class="first">Hover over the highlighted payload and notice that the powershell attack signature is triggered.</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image14.png"><img alt="module2Lab3Task1-image14" src="../../_images/module2Lab3Task1-image14.png" style="width: 400px;" /></a></p>
<p>Powershell execution via http parameters is now mitigated. If you noticed in the request, that the <strong>|</strong> is considered illegal.
What if that character was a legitimate value for a parameter?</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image15.png"><img alt="module2Lab3Task1-image15" src="../../_images/module2Lab3Task1-image15.png" style="width: 400px;" /></a></p>
</li>
<li><p class="first">Go back to the command prompt on the jumphost and run</p>
<p><strong>curl -k “https://api.acme.com/vulnerable?param1=|legitimate%20value” -v</strong></p>
</li>
<li><p class="first">Navigate to <strong>Security -&gt; Event Logs -&gt; Application -&gt; Requests</strong> and find this latest request. Notice the <strong>|</strong> is considered illegal. However its not blocked, the Enforcement Action is None</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image16.png"><img alt="module2Lab3Task1-image16" src="../../_images/module2Lab3Task1-image16.png" style="width: 400px;" /></a></p>
</li>
<li><p class="first">To see why this parameter character violation is not being blocked, but is being logged (alarmed). Navaigate to <strong>Security -&gt; Application Security -&gt; Policy Building -&gt; Learning and Blocking Settings -&gt; Parameters</strong> and enable the <strong>Block</strong> column for the <strong>Illegal meta character in value</strong> under the Parameters Section</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image17.png"><img alt="module2Lab3Task1-image17" src="../../_images/module2Lab3Task1-image17.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Click <strong>Save</strong> then <strong>Apply Policy</strong></p>
</li>
<li><p class="first">Go back to the command prompt on the jumphost and run</p>
<p><strong>curl -k “https://api.acme.com/vulnerable?param1=|legitimate%20value” -v</strong></p>
</li>
<li><p class="first">Navigate to <strong>Security -&gt; Event Logs -&gt; Application -&gt; Requests</strong> and find this latest request. Notice the <strong>|</strong> is considered illegal and is now blocked.</p>
<p><a class="reference internal" href="../../_images/module2Lab3Task1-image18.png"><img alt="module2Lab3Task1-image18" src="../../_images/module2Lab3Task1-image18.png" style="width: 800px;" /></a></p>
</li>
</ol>
</div>
<div class="section" id="task-2-implement-static-parameter-values">
<h3>Task 2 - Implement Static Parameter values<a class="headerlink" href="#task-2-implement-static-parameter-values" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">From Postman, click “Send” on the <strong>Request 2: SSRF Attack-Google</strong> request.</p>
<p><a class="reference internal" href="../../_images/118.png"><img alt="image118" src="../../_images/118.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">From Postman, run <strong>Request 3: SSRF Attack-unprotected-json</strong>. This site contains an example ID and Secret key in JSON format. You can now see the endpoint is vulnerable to Server Side Request Forgery attacks because the endpoint can be directed to locations other than Google.  Hackers will uses your servers as a jump off point to gain access to internal resources.</p>
<p><a class="reference internal" href="../../_images/119.png"><img alt="image119" src="../../_images/119.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Navigate to <strong>Security -&gt; Event Logs -&gt; Application -&gt; Requests</strong> and find both requests.  Notice nothing appears malicious about these requests except for the destinations.</p>
<p><a class="reference internal" href="../../_images/image1203.png"><img alt="image120" src="../../_images/image1203.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">We are going to secure the the uri parameter, so it only allows access to Google, but not access to the internal private data.</p>
</li>
<li><p class="first">Navigate to <strong>Security -&gt; Application Security -&gt; Parameters -&gt; Parameters List</strong>.  Click the <strong>+ Plus Symbol</strong></p>
<p><a class="reference internal" href="../../_images/image1214.png"><img alt="image121" src="../../_images/image1214.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Enter the Name <strong>uri</strong></p>
</li>
<li><p class="first">Uncheck <strong>Perform Staging</strong></p>
</li>
<li><p class="first">From the Parameter Value Type dropdown select <strong>Static Content Value</strong></p>
</li>
<li><p class="first">Enter <strong>https://www.google.com</strong> for the New Static Value</p>
</li>
<li><p class="first">Click <strong>Add</strong></p>
</li>
<li><p class="first">Click <strong>Create</strong></p>
<p><a class="reference internal" href="../../_images/122.png"><img alt="image122" src="../../_images/122.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Click <strong>Apply Policy</strong></p>
</li>
<li><p class="first">From Postman, run <strong>Request 2: SSRF Attack-Google</strong>.  Access to Google is still allowed.</p>
</li>
<li><p class="first">From Post, run <strong>Request 3: SSRF Attack-unprotected-json</strong>. This site is now blocked as intended</p>
<p><a class="reference internal" href="../../_images/image1233.png"><img alt="image123" src="../../_images/image1233.png" style="width: 800px;" /></a></p>
</li>
<li><p class="first">Navigate to <strong>Security -&gt; Event Logs -&gt; Application -&gt; Requests</strong> and find the latest blocked request.  The uri parameter is highlighted due to Illegal Static Parameter Value.</p>
<p><a class="reference internal" href="../../_images/image1243.png"><img alt="image124" src="../../_images/image1243.png" style="width: 800px;" /></a></p>
</li>
</ol>
</div>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="lab01.html" title="Lab 1: Deploy an API Protection Profile" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="../module5/intro.html" title="Environment Overview" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>