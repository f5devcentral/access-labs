<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>Lab 5: SAML Identity Provider (IdP) - Certificate Auth</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="Lab 5: SAML Identity Provider (IdP) - Certificate Auth"/>
  <meta name="product" content="F5 Identity and Access Management Solutions"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2021-06-21 13:23:29"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 Identity and Access Management Solutions" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab 5: SAML Identity Provider (IdP) - Certificate Auth &#8212; F5 Identity and Access Management Solutions  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/CoveoFullSearch.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/21fb8a09c3.css" type="text/css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Lab 6: SAML IdP Chaining to AzureAD (BIG-IP Primary IdP)" href="lab06.html" />
    <link rel="prev" title="Lab 4: SAML Identity Provider (IdP) - LocalDB Auth" href="lab04.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 Identity and Access Management Solutions  </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../class1/class1.html">100 Series: Access Foundational Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class2/class2.html">200 Series: Assisted Deployment Use Cases</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../class3.html">300 Series: Advanced Use Cases &amp; Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class4/class4.html">400 Series: Access Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class5/class5.html">500 Series: Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archived/archived.html">Archived Identity &amp; Access Management Labs</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">Lab 5: SAML Identity Provider (IdP) - Certificate Auth</a><ul>
<li><a class="reference internal" href="#task-1-setup-lab-environment">Task 1 - Setup Lab Environment</a></li>
<li><a class="reference internal" href="#task-2-configure-the-saml-identity-provider-idp">Task 2 ‑ Configure the SAML Identity Provider (IdP)</a><ul>
<li><a class="reference internal" href="#idp-service">IdP Service</a></li>
<li><a class="reference internal" href="#sp-connector">SP Connector</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-3-create-a-saml-resource">Task 3 - Create a SAML Resource</a></li>
<li><a class="reference internal" href="#task-4-create-a-webtop">Task 4 - Create a Webtop</a></li>
<li><a class="reference internal" href="#task-5-create-an-ocsp-responder">Task 5 - Create an OCSP Responder</a></li>
<li><a class="reference internal" href="#task-6-create-an-aaa-ldap-server">Task 6 - Create an AAA LDAP Server</a></li>
<li><a class="reference internal" href="#task-7-create-a-saml-idp-access-policy">Task 7 - Create a SAML IdP Access Policy</a></li>
<li><a class="reference internal" href="#task-8-create-a-client-side-ssl-profile">Task 8 - Create a Client-side SSL Profile</a></li>
<li><a class="reference internal" href="#task-9-create-an-idp-virtual-server">Task 9 - Create an IdP Virtual Server</a></li>
<li><a class="reference internal" href="#task-10-test-the-configuration">Task 10 - Test the Configuration</a></li>
<li><a class="reference internal" href="#task-11-lab-cleanup">Task 11 - Lab Cleanup</a></li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">F5 Identity and Access Management Solutions</a>
              &gt; <a href="../class3.html">300 Series: Advanced Use Cases &amp; Solutions</a>

          <span class="right">
             <a href="../../_sources/class3/module1/lab05.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/f5devcentral/f5-agility-labs-iam">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="lab-5-saml-identity-provider-idp-certificate-auth">
<h1>Lab 5: SAML Identity Provider (IdP) - Certificate Auth<a class="headerlink" href="#lab-5-saml-identity-provider-idp-certificate-auth" title="Permalink to this headline">¶</a></h1>
<div class="section" id="task-1-setup-lab-environment">
<h2>Task 1 - Setup Lab Environment<a class="headerlink" href="#task-1-setup-lab-environment" title="Permalink to this headline">¶</a></h2>
<p>To access your dedicated student lab environment, you will need a web browser and Remote Desktop Protocol (RDP) client software. The web browser will be used to access the Unified Demo Framework (UDF) Training Portal. The RDP client will be used to connect to the jumphost, where you will be able to access the BIG-IP management interfaces (HTTPS, SSH).</p>
<ol class="arabic">
<li><p class="first">Click <strong>DEPLOYMENT</strong> located on the top left corner to display the environment</p>
</li>
<li><p class="first">Click <strong>ACCESS</strong> next to jumphost.f5lab.local</p>
<p><img alt="image001" src="../../_images/00113.png" /></p>
</li>
<li><p class="first">Select your RDP resolution.</p>
</li>
<li><p class="first">The RDP client on your local host establishes a RDP connection to the Jump Host.</p>
</li>
<li><p class="first">Login with the following credentials:</p>
<blockquote>
<div><ul class="simple">
<li>User: <strong>f5lab\user1</strong></li>
<li>Password: <strong>user1</strong></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">After successful logon the Chrome browser will auto launch opening the site <a class="reference external" href="https://portal.f5lab.local">https://portal.f5lab.local</a>.  This process usually takes 30 seconds after logon.</p>
</li>
<li><p class="first">Click the <strong>Classes</strong> tab at the top of the page.</p>
<blockquote>
<div><p><img alt="image002" src="../../_images/00213.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Scroll down the page until you see <strong>301 SAML Federation</strong> on the left</p>
<p><img alt="image003" src="../../_images/00313.png" /></p>
</li>
<li><p class="first">Hover over tile <strong>SAML Identity Provider (IdP) - Cert Auth</strong>. A start and stop icon should appear within the tile.  Click the <strong>Play</strong> Button to start the automation to build the environment</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="54%" />
<col width="46%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><img alt="image004" src="../../_images/00413.png" /></td>
<td><img alt="image005" src="../../_images/00513.png" /></td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">The screen should refresh displaying the progress of the automation within 30 seconds.  Scroll to the bottom of the automation workflow to ensure all requests succeeded.  If you experience errors try running the automation a second time or open an issue on the <a class="reference external" href="https://github.com/f5devcentral/access-labs">Access Labs Repo</a>.</p>
<p><img alt="image006" src="../../_images/00613.png" /></p>
</li>
</ol>
</div>
<div class="section" id="task-2-configure-the-saml-identity-provider-idp">
<h2>Task 2 ‑ Configure the SAML Identity Provider (IdP)<a class="headerlink" href="#task-2-configure-the-saml-identity-provider-idp" title="Permalink to this headline">¶</a></h2>
<div class="section" id="idp-service">
<h3>IdP Service<a class="headerlink" href="#idp-service" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Begin by selecting: <strong>Access ‑&gt; Federation ‑&gt; SAML Identity Provider
‑&gt; Local IdP Services</strong></p>
</li>
<li><p class="first">Click the <strong>Create</strong> button (far right)</p>
<p><img alt="image009" src="../../_images/00913.png" /></p>
</li>
<li><p class="first">In the <strong>Create New SAML IdP Service</strong> dialog box, click <strong>General Settngs</strong>
in the left navigation pane and key in the following:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="37%" />
<col width="63%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>IdP Service Name:</td>
<td><code class="docutils literal notranslate"><span class="pre">idp.acme.com</span></code></td>
</tr>
<tr class="row-even"><td>IdP Entity ID:</td>
<td><code class="docutils literal notranslate"><span class="pre">https://idp.acme.com</span></code></td>
</tr>
</tbody>
</table>
<p><img alt="image010" src="../../_images/01014.png" /></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The yellow box on “Host” will disappear when the Entity ID is
entered</p>
</div>
</li>
<li><p class="first">In the <strong>Create New SAML IdP Service</strong> dialog box, click <strong>Assertion
Settings</strong> in the left navigation pane and key in the following:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="38%" />
<col width="62%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Assertion Subject Type:</td>
<td><code class="docutils literal notranslate"><span class="pre">Persistent</span> <span class="pre">Identifier</span></code> (drop down)</td>
</tr>
<tr class="row-even"><td>Assertion Subject Value:</td>
<td><code class="docutils literal notranslate"><span class="pre">%{session.logon.last.username}</span></code> (drop down)</td>
</tr>
<tr class="row-odd"><td>Authentication Context Class Reference</td>
<td><code class="docutils literal notranslate"><span class="pre">urn:oasis:names:tc:SAML:2.0:ac:classes:SmartcardPKI</span></code></td>
</tr>
</tbody>
</table>
<p><img alt="image011" src="../../_images/01115.png" /></p>
</li>
<li><p class="first">In the <strong>Create New SAML IdP Service</strong> dialog box, click
<strong>Security Settings</strong> in the left navigation pane and key in
the following:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="36%" />
<col width="64%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Signing Key:</td>
<td><code class="docutils literal notranslate"><span class="pre">/Common/idp.acme.com</span></code> (drop down)</td>
</tr>
<tr class="row-even"><td>Signing Certificate:</td>
<td><code class="docutils literal notranslate"><span class="pre">/Common/idp.acme.com</span></code> (drop down)</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The certificate and key were previously imported</p>
</div>
</li>
<li><p class="first">Click <strong>OK</strong> to complete the creation of the IdP service</p>
<p><img alt="image012" src="../../_images/01215.png" /></p>
</li>
</ol>
</div>
<div class="section" id="sp-connector">
<h3>SP Connector<a class="headerlink" href="#sp-connector" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Click on <strong>External SP Connectors</strong> (under the <strong>SAML Identity Provider</strong>
tab) in the horizontal navigation menu</p>
</li>
<li><p class="first">Click specifically on the <strong>Down Arrow</strong> next to the <strong>Create</strong> button
(far right)</p>
</li>
<li><p class="first">Select <strong>From Metadata</strong> from the drop down menu</p>
<p><img alt="image013" src="../../_images/01315.png" /></p>
</li>
<li><p class="first">In the <strong>Create New SAML Service Provider</strong> dialogue box, click <strong>Browse</strong>
and select the <em>sp_acme_com.xml</em> file from the Desktop of
your jump host</p>
</li>
<li><p class="first">In the <strong>Service Provider Name</strong> field, enter the following:
<code class="docutils literal notranslate"><span class="pre">sp.acme.com</span></code></p>
</li>
<li><p class="first">Click <strong>OK</strong> on the dialog box</p>
<p><img alt="image014" src="../../_images/01414.png" /></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The sp_acme_com.xml file was created previously.
Oftentimes SP providers will have a metadata file representing their
SP service. This can be imported to save object creation time as has
been done in this lab.</p>
</div>
</li>
<li><p class="first">Click on <strong>Local IdP Services</strong> (under the <strong>SAML Identity Provider</strong> tab)
in the horizontal navigation menu</p>
<p><img alt="image015" src="../../_images/01514.png" /></p>
</li>
<li><p class="first">Select the <strong>Checkbox</strong> next to the previously created <code class="docutils literal notranslate"><span class="pre">idp.acme.com</span></code>
and click the <strong>Bind/Unbind SP Connectors</strong> button at the bottom of the GUI</p>
<p><img alt="image016" src="../../_images/01613.png" /></p>
</li>
<li><p class="first">In the <strong>Edit SAML SP’s that use this IdP</strong> dialog, select the
<code class="docutils literal notranslate"><span class="pre">/Common/sp.acme.com</span></code> SAML SP Connection Name created previously</p>
</li>
<li><p class="first">Click the <strong>OK</strong> button at the bottom of the dialog box</p>
<p><img alt="image017" src="../../_images/01713.png" /></p>
</li>
<li><p class="first">Under the <strong>Access ‑&gt; Federation ‑&gt; SAML Identity Provider ‑&gt;
Local IdP Services</strong> menu you should now see the following (as shown):</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="47%" />
<col width="53%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Name:</td>
<td><code class="docutils literal notranslate"><span class="pre">idp.acme.com</span></code></td>
</tr>
<tr class="row-even"><td>SAML SP Connectors:</td>
<td><code class="docutils literal notranslate"><span class="pre">sp.acme.com</span></code></td>
</tr>
</tbody>
</table>
<p><img alt="image018" src="../../_images/01813.png" /></p>
</li>
</ol>
</div>
</div>
<div class="section" id="task-3-create-a-saml-resource">
<h2>Task 3 - Create a SAML Resource<a class="headerlink" href="#task-3-create-a-saml-resource" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Begin by selecting <strong>Access ‑&gt; Federation ‑&gt; SAML Resources &gt;&gt; **Plus (+) Sign</strong></p>
<p><img alt="image019" src="../../_images/01914.png" /></p>
</li>
<li><p class="first">In the <strong>New SAML Resource</strong> window, enter the following values:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Name:</td>
<td><code class="docutils literal notranslate"><span class="pre">sp.acme.com</span></code></td>
</tr>
<tr class="row-even"><td>SSO Configuration:</td>
<td><code class="docutils literal notranslate"><span class="pre">idp.acmem.com</span></code></td>
</tr>
<tr class="row-odd"><td>Caption:</td>
<td><code class="docutils literal notranslate"><span class="pre">sp.acme.com</span></code></td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Click <strong>Finished</strong> at the bottom of the configuration window</p>
<p><img alt="image020" src="../../_images/02013.png" /></p>
</li>
</ol>
</div>
<div class="section" id="task-4-create-a-webtop">
<h2>Task 4 - Create a Webtop<a class="headerlink" href="#task-4-create-a-webtop" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Select Access ‑&gt; Webtops ‑&gt; Webtop Lists &gt;&gt; <strong>Plus (+) Sign</strong></p>
<p><img alt="image021" src="../../_images/02112.png" /></p>
</li>
<li><p class="first">In the resulting window, enter the following values:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Name:</td>
<td><code class="docutils literal notranslate"><span class="pre">full_webtop</span></code></td>
</tr>
<tr class="row-even"><td>Type:</td>
<td><code class="docutils literal notranslate"><span class="pre">Full</span></code> (drop down)</td>
</tr>
<tr class="row-odd"><td>Minimize To Tray</td>
<td><code class="docutils literal notranslate"><span class="pre">uncheck</span></code></td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Click <strong>Finished</strong> at the bottom of the GUI</p>
<p><img alt="image022" src="../../_images/02212.png" /></p>
</li>
</ol>
</div>
<div class="section" id="task-5-create-an-ocsp-responder">
<h2>Task 5 - Create an OCSP Responder<a class="headerlink" href="#task-5-create-an-ocsp-responder" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to Access &gt;&gt; Authentication &gt;&gt; OCSP Responder &gt;&gt; Click the <strong>Plus (+) Sign</strong>.</p>
<p><img alt="image023" src="../../_images/02313.png" /></p>
</li>
<li><p class="first">Enter the following information for the OCSP Responder configuration:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="52%" />
<col width="48%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Name:</td>
<td><code class="docutils literal notranslate"><span class="pre">ocsp_servers</span></code></td>
</tr>
<tr class="row-even"><td>Configuration:</td>
<td><code class="docutils literal notranslate"><span class="pre">Advanced</span></code></td>
</tr>
<tr class="row-odd"><td>URL:</td>
<td><code class="docutils literal notranslate"><span class="pre">http://dc1.f5lab.local</span></code></td>
</tr>
<tr class="row-even"><td>Certificate Authority File</td>
<td><code class="docutils literal notranslate"><span class="pre">ca.f5lab.local</span></code></td>
</tr>
<tr class="row-odd"><td>Certificate Authority Path:</td>
<td><code class="docutils literal notranslate"><span class="pre">/ocsp</span></code></td>
</tr>
<tr class="row-even"><td>Options:</td>
<td>Uncheck <code class="docutils literal notranslate"><span class="pre">Nonce</span></code></td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
<blockquote>
<div><p><img alt="image024" src="../../_images/02412.png" /></p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="task-6-create-an-aaa-ldap-server">
<h2>Task 6 - Create an AAA LDAP Server<a class="headerlink" href="#task-6-create-an-aaa-ldap-server" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to Access &gt;&gt; Authentication &gt;&gt; LDAP &gt;&gt; Click the <strong>Plus (+) Sign</strong>.</p>
<blockquote>
<div><p><img alt="image025" src="../../_images/02512.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Enter the following information for the LDAP Server configuration:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Name:</td>
<td><code class="docutils literal notranslate"><span class="pre">ldap_servers</span></code></td>
</tr>
<tr class="row-even"><td>Server Connection:</td>
<td><code class="docutils literal notranslate"><span class="pre">Use</span> <span class="pre">Pool</span></code></td>
</tr>
<tr class="row-odd"><td>Server Pool Name:</td>
<td><code class="docutils literal notranslate"><span class="pre">ldap_pool</span></code></td>
</tr>
<tr class="row-even"><td>Server Addresses:</td>
<td><code class="docutils literal notranslate"><span class="pre">10.1.20.7</span></code></td>
</tr>
<tr class="row-odd"><td>Admin DN:</td>
<td><code class="docutils literal notranslate"><span class="pre">CN=admin,CN=Users,DC=f5lab,DC=local</span></code></td>
</tr>
<tr class="row-even"><td>Admin Password:</td>
<td><code class="docutils literal notranslate"><span class="pre">admin</span></code></td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
<blockquote>
<div><p><img alt="image026" src="../../_images/02612.png" /></p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="task-7-create-a-saml-idp-access-policy">
<h2>Task 7 - Create a SAML IdP Access Policy<a class="headerlink" href="#task-7-create-a-saml-idp-access-policy" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Select <strong>Access ‑&gt; Profiles/Policies ‑&gt; Access Profiles
(Per-Session Policies)</strong></p>
</li>
<li><p class="first">Click the <strong>Create</strong> button (far right)</p>
<p><img alt="image027" src="../../_images/02711.png" /></p>
</li>
<li><p class="first">In the <strong>New Profile</strong> window, enter the following information:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Name:</td>
<td><code class="docutils literal notranslate"><span class="pre">idp.acme.com‑psp</span></code></td>
</tr>
<tr class="row-even"><td>Profile Type:</td>
<td><code class="docutils literal notranslate"><span class="pre">All</span></code> (drop down)</td>
</tr>
<tr class="row-odd"><td>Profile Scope:</td>
<td><code class="docutils literal notranslate"><span class="pre">Profile</span></code> (default)</td>
</tr>
<tr class="row-even"><td>Customization Type:</td>
<td><code class="docutils literal notranslate"><span class="pre">modern</span></code> (default)</td>
</tr>
</tbody>
</table>
<p><img alt="image028" src="../../_images/02811.png" /></p>
</li>
<li><p class="first">Scroll to the bottom of the <strong>New Profile</strong> window to the
<strong>Language Settings</strong> section</p>
</li>
<li><p class="first">Select <em>English</em> from the <strong>Factory Built‑in Languages</strong> menu on the
right and click the <strong>Double Arrow (&lt;&lt;)</strong>, then click the <strong>Finished</strong>
button.</p>
</li>
<li><p class="first">The <strong>Default Language</strong> should be automatically set</p>
<p><img alt="image029" src="../../_images/02911.png" /></p>
</li>
<li><p class="first">From the <strong>Access ‑&gt; Profiles/Policies ‑&gt; Access Profiles
(Per-Session Policies) screen</strong>, click the <strong>Edit</strong> link on the previously
created <code class="docutils literal notranslate"><span class="pre">idp.acme.com-psp</span></code> line</p>
<p><img alt="image030" src="../../_images/03010.png" /></p>
</li>
<li><p class="first">Click the <strong>Plus (+) Sign</strong> between <strong>Start</strong> and <strong>Deny</strong></p>
<p><img alt="image031" src="../../_images/0319.png" /></p>
</li>
<li><p class="first">In the pop-up dialog box, select the <strong>Authentication</strong> tab and then select the
<strong>Radio</strong> next to <strong>On-Demand Cert Auth</strong>, and click the <strong>Add Item</strong> button</p>
<p><img alt="image032" src="../../_images/0329.png" /></p>
</li>
<li><p class="first">Click <strong>Save</strong> in the resulting Logon Page dialog box</p>
<p><img alt="image033" src="../../_images/0339.png" /></p>
</li>
<li><p class="first">On the successful branch of the On-Demand Cert Auth Policy-Item click the <strong>Plus (+) Sign</strong></p>
<p><img alt="image034" src="../../_images/0349.png" /></p>
</li>
<li><p class="first">In the pop-up dialog box, select the <strong>Authentication</strong> tab and then select the <strong>Radio</strong> next to <strong>OCSP Auth</strong>, and click the <strong>Add Item</strong> button</p>
<p><img alt="image035" src="../../_images/0359.png" /></p>
</li>
<li><p class="first">Select <code class="docutils literal notranslate"><span class="pre">/Common/ocsp_servers</span></code> from the <strong>OCSP Responder</strong> drop down menu.</p>
</li>
<li><p class="first">Click <strong>Save</strong> at the bottom of the window</p>
<p><img alt="image036" src="../../_images/0368.png" /></p>
</li>
<li><p class="first">Click the <strong>Plus (+) Sign</strong> on the successful branch between <strong>OCSP Auth</strong> and <strong>Deny</strong></p>
<p><img alt="image037" src="../../_images/0377.png" /></p>
</li>
<li><p class="first">In the pop-up dialog box, select the <strong>Assignment</strong> tab and then select
the <strong>Radio</strong> next to <strong>Variable Assign</strong>, and click the
<strong>Add Item</strong> button</p>
<p><img alt="image038" src="../../_images/0387.png" /></p>
</li>
<li><p class="first">Enter the Name <strong>upn_extract</strong></p>
</li>
<li><p class="first">Click <strong>Add new entry</strong></p>
</li>
<li><p class="first">Click <strong>Change</strong></p>
<blockquote>
<div><p><img alt="image039" src="../../_images/0397.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Enter the Custom Variable <strong>session.custom.upn</strong></p>
</li>
<li><p class="first">Select <strong>Custom Expresssion</strong> from the right drop down menu</p>
</li>
<li><p class="first">Enter the text below for the custom expression.</p>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>set x509e_fields [split [mcget {session.ssl.cert.x509extension}] &quot;\n&quot;];
# For each element in the list:
foreach field $x509e_fields {
# If the element contains UPN:
if { $field contains &quot;othername:UPN&quot; } {
## set start of UPN variable
set start [expr {[string first &quot;othername:UPN&lt;&quot; $field] +14}]
# UPN format is &lt;user@domain&gt;
# Return the UPN, by finding the index of opening and closing brackets, then use string range to get everything between.
return [string range $field $start [expr { [string first &quot;&gt;&quot; $field $start] - 1 } ] ];  } }
#Otherwise return UPN Not Found:
return &quot;UPN-NOT-FOUND&quot;;
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
<blockquote>
<div><p><img alt="image040" src="../../_images/0406.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<blockquote>
<div><p><img alt="image041" src="../../_images/0416.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click the <strong>Plus (+) Sign</strong> between <strong>upn_extract</strong> and <strong>Deny</strong></p>
<blockquote>
<div><p><img alt="image042" src="../../_images/0426.png" /></p>
</div></blockquote>
</li>
<li><p class="first">In the pop-up dialog box, select the <strong>Authentication</strong> tab and then select
the <strong>Radio</strong> next to <strong>LDAP Query</strong>, and click the
<strong>Add Item</strong> button</p>
<p><img alt="image043" src="../../_images/0435.png" /></p>
</li>
<li><p class="first">In the <strong>LDAP Query Properties</strong> window, enter the following information:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="31%" />
<col width="69%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Server:</td>
<td><code class="docutils literal notranslate"><span class="pre">/Common/ldap_servers</span></code> (drop down)</td>
</tr>
<tr class="row-even"><td>Search DN:</td>
<td><code class="docutils literal notranslate"><span class="pre">dc=f5lab,dc=local</span></code> (drop down)</td>
</tr>
<tr class="row-odd"><td>SearchFilter:</td>
<td><code class="docutils literal notranslate"><span class="pre">(userPrincipalName=%{session.custom.upn})</span></code></td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Click <strong>Add new entry</strong></p>
</li>
<li><p class="first">Add <strong>sAMAAccountName</strong> to the list of Required Attributes</p>
<blockquote>
<div><p><img alt="image044" src="../../_images/0446.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click the <strong>Branch Rules</strong> tab</p>
</li>
<li><p class="first">Click the <strong>X</strong> on the User Group Membership line</p>
<blockquote>
<div><p><img alt="image045" src="../../_images/0456.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Add Branch Rule</strong></p>
<blockquote>
<div><p><img alt="image046" src="../../_images/0464.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Enter the name <strong>LDAP Query Passed</strong></p>
</li>
<li><p class="first">Click <strong>change</strong></p>
<blockquote>
<div><p><img alt="image047" src="../../_images/0474.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Add Expression</strong></p>
<blockquote>
<div><p><img alt="image048" src="../../_images/0484.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Select <strong>LDAP Query</strong> from the Context dropdown menu</p>
</li>
<li><p class="first">Select <strong>LDAP Query Passed</strong> from the Condition dropdown menu</p>
</li>
<li><p class="first">Click <strong>Add Expression</strong></p>
<blockquote>
<div><p><img alt="image049" src="../../_images/0494.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Finsished</strong></p>
<blockquote>
<div><p><img alt="image050" src="../../_images/0504.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<blockquote>
<div><p><img alt="image051" src="../../_images/0513.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click the <strong>Plus (+) Sign</strong> on the LDAP Query Passed branch between <strong>LDAP Query</strong> and <strong>Deny</strong></p>
<blockquote>
<div><p><img alt="image052" src="../../_images/0523.png" /></p>
</div></blockquote>
</li>
<li><p class="first">In the pop-up dialog box, select the <strong>Assignment</strong> tab and then select
the <strong>Radio</strong> next to <strong>Variable Assign</strong>, and click the
<strong>Add Item</strong> button</p>
<p><img alt="image053" src="../../_images/0533.png" /></p>
</li>
<li><p class="first">Enter the Name <strong>set_username</strong></p>
</li>
<li><p class="first">Click <strong>Add new entry</strong></p>
</li>
<li><p class="first">Click <strong>Change</strong></p>
<blockquote>
<div><p><img alt="image054" src="../../_images/0543.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Enter the Custom Variable <strong>session.logon.last.username</strong></p>
</li>
<li><p class="first">Select <strong>Session Variable</strong> from the right drop down menu</p>
</li>
<li><p class="first">Enter the session variable name <strong>session.ldap.last.attr.sAMAccountName</strong></p>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
<blockquote>
<div><p><img alt="image055" src="../../_images/0553.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Save</strong></p>
<blockquote>
<div><p><img alt="image056" src="../../_images/0563.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click the <strong>Plus (+) Sign</strong> between <strong>set_username</strong> and <strong>Deny</strong></p>
<blockquote>
<div><p><img alt="image057" src="../../_images/0573.png" /></p>
</div></blockquote>
</li>
<li><p class="first">In the pop-up dialog box, select the <strong>Assignment</strong> tab and then select
the <strong>Radio</strong> next to <strong>Advanced Resource Assign</strong>, and click the
<strong>Add Item</strong> button</p>
<p><img alt="image058" src="../../_images/0582.png" /></p>
</li>
<li><p class="first">In the new Resource Assignment entry, click the <strong>Add/Delete</strong> link</p>
<p><img alt="image059" src="../../_images/0592.png" /></p>
</li>
<li><p class="first">In the resulting pop-up window, click the <strong>SAML</strong> tab, and select the
<strong>Checkbox</strong> next to <code class="docutils literal notranslate"><span class="pre">/Common/sp.acme.com</span></code></p>
<p><img alt="image060" src="../../_images/0602.png" /></p>
</li>
<li><p class="first">Click the <strong>Webtop</strong> tab, and select the <strong>Checkbox</strong> next to
<code class="docutils literal notranslate"><span class="pre">/Common/full_webtop</span></code></p>
</li>
<li><p class="first">Click the <strong>Update</strong> button at the bottom of the window to complete
the Resource Assignment entry</p>
<p><img alt="image061" src="../../_images/0612.png" /></p>
</li>
<li><p class="first">Click the <strong>Save</strong> button at the bottom of the <strong>Advanced Resource Assign</strong> window</p>
<p><img alt="image062" src="../../_images/0622.png" /></p>
</li>
<li><p class="first">In the <strong>Visual Policy Editor</strong>, select the <strong>Deny</strong> ending on the
fallback branch following <strong>Advanced Resource Assign</strong></p>
<p><img alt="image063" src="../../_images/0631.png" /></p>
</li>
<li><p class="first">In the <strong>Select Ending</strong> dialog box, selet the <strong>Allow</strong> radio button
and then click <strong>Save</strong></p>
<p><img alt="image064" src="../../_images/0641.png" /></p>
</li>
<li><p class="first">In the <strong>Visual Policy Editor</strong>, click <strong>Apply Access Policy</strong>
(top left), and close the <strong>Visual Policy Editor</strong></p>
<p><img alt="image065" src="../../_images/065.png" /></p>
</li>
</ol>
</div>
<div class="section" id="task-8-create-a-client-side-ssl-profile">
<h2>Task 8 - Create a Client-side SSL Profile<a class="headerlink" href="#task-8-create-a-client-side-ssl-profile" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to Local Traffic ‑&gt; Profile -&gt; SSL -&gt; Client. Click the <strong>Plus (+) Sign</strong></p>
<blockquote>
<div><p><img alt="image066" src="../../_images/066.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Enter the Name <strong>idp.acme.com-clientssl</strong></p>
</li>
<li><p class="first">Check the <strong>custom box</strong> on the Certificate Key Chain Line</p>
</li>
<li><p class="first">Click <strong>Add</strong></p>
<blockquote>
<div><p><img alt="image067" src="../../_images/067.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Select <strong>acme.com-wildcard</strong> from the Certificate dropdown menu</p>
</li>
<li><p class="first">Select <strong>acme.com-wildcard</strong> from the Key dropdown menu</p>
</li>
<li><p class="first">Click <strong>Add</strong></p>
<blockquote>
<div><p><img alt="image068" src="../../_images/068.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Check the <strong>custom box</strong> on the Trusted Certificate Authorities Line</p>
</li>
<li><p class="first">Select <strong>ca.f5lab.local</strong> from the Trusted Certificate Authorities dropdown menu</p>
</li>
<li><p class="first">Check the <strong>custom box</strong> on the Advertised Certificate Authorities Line</p>
</li>
<li><p class="first">Select <strong>ca.f5lab.local</strong> from the Advertised Certificate Authorities dropdown menu</p>
<blockquote>
<div><p><img alt="image069" src="../../_images/069.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Finished</strong></p>
</li>
</ol>
</div>
<div class="section" id="task-9-create-an-idp-virtual-server">
<h2>Task 9 - Create an IdP Virtual Server<a class="headerlink" href="#task-9-create-an-idp-virtual-server" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Begin by selecting Local Traffic ‑&gt; Virtual Servers -&gt; Virtual Server List. Click the <strong>Plus (+) Sign</strong></p>
<p><img alt="image070" src="../../_images/070.png" /></p>
</li>
<li><p class="first">In the <strong>New Virtual Server</strong> window, enter the following information:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="47%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="2">General Properties</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Name:</td>
<td><code class="docutils literal notranslate"><span class="pre">idp.acme.com</span></code></td>
</tr>
<tr class="row-odd"><td>Destination Address/Mask:</td>
<td><code class="docutils literal notranslate"><span class="pre">10.1.10.102</span></code></td>
</tr>
<tr class="row-even"><td>Service Port:</td>
<td><code class="docutils literal notranslate"><span class="pre">443</span></code></td>
</tr>
</tbody>
</table>
<p><img alt="image071" src="../../_images/071.png" /></p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="47%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="2">Configuration</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>HTTP Profile:</td>
<td><code class="docutils literal notranslate"><span class="pre">http</span></code> (drop down)</td>
</tr>
<tr class="row-odd"><td>SSL Profile (Client)</td>
<td><code class="docutils literal notranslate"><span class="pre">idp.acme.com-clientssl</span></code></td>
</tr>
</tbody>
</table>
<p><img alt="image072" src="../../_images/072.png" /></p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="39%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="2">Access Policy</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Access Profile:</td>
<td><code class="docutils literal notranslate"><span class="pre">idp.acme.com-psp</span></code></td>
</tr>
</tbody>
</table>
<p><img alt="image073" src="../../_images/073.png" /></p>
</li>
<li><p class="first">Scroll to the bottom of the configuration window and click <strong>Finished</strong></p>
</li>
</ol>
</div>
<div class="section" id="task-10-test-the-configuration">
<h2>Task 10 - Test the Configuration<a class="headerlink" href="#task-10-test-the-configuration" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">From the jumphost, navigate to the SAML IdP you previously configured at <strong>https://idp.acme.com</strong>.</p>
</li>
<li><p class="first">Select the <strong>user1</strong> certificate</p>
</li>
<li><p class="first">Click <strong>OK</strong></p>
<p><img alt="image074" src="../../_images/074.png" /></p>
</li>
<li><p class="first">Click <strong>sp.acme.com</strong></p>
<p><img alt="image075" src="../../_images/075.png" /></p>
</li>
<li><p class="first">You are then successfully logged into <a class="reference external" href="https://sp.acme.com">https://sp.acme.com</a> and presented a webpage.</p>
<p><img alt="image076" src="../../_images/076.png" /></p>
</li>
<li><p class="first">Review your Active Sessions <strong>(Access ‑&gt; Overview ‑&gt; Active Sessions­­­)</strong></p>
</li>
<li><p class="first">Review your Access Report Logs <strong>(Access ‑&gt; Overview ‑&gt; Access Reports)</strong></p>
</li>
</ol>
</div>
<div class="section" id="task-11-lab-cleanup">
<h2>Task 11 - Lab Cleanup<a class="headerlink" href="#task-11-lab-cleanup" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">From a browser on the jumphost navigate to <a class="reference external" href="https://portal.f5lab.local">https://portal.f5lab.local</a></p>
</li>
<li><p class="first">Click the <strong>Classes</strong> tab at the top of the page.</p>
<p><img alt="image002" src="../../_images/00213.png" /></p>
</li>
<li><p class="first">Scroll down the page until you see <strong>301 SAML Federation</strong> on the left</p>
<p><img alt="image003" src="../../_images/00313.png" /></p>
</li>
<li><p class="first">Hover over tile <strong>SAML Identity Provider (IdP) - Cert Auth</strong>. A start and stop icon should appear within the tile.  Click the <strong>Stop</strong> Button to trigger the automation to remove any prebuilt objects from the environment</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="54%" />
<col width="46%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><img alt="image004" src="../../_images/00413.png" /></td>
<td><img alt="image007" src="../../_images/00714.png" /></td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">The screen should refresh displaying the progress of the automation within 30 seconds.  Scroll to the bottom of the automation workflow to ensure all requests succeeded.  If you you experience errors try running the automation a second time or open an issue on the <a class="reference external" href="https://github.com/f5devcentral/access-labs">Access Labs Repo</a>.</p>
<p><img alt="image008" src="../../_images/00813.png" /></p>
</li>
<li><p class="first">This concludes the lab.</p>
<p><img alt="image000" src="../../_images/00018.png" /></p>
</li>
</ol>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="lab04.html" title="Lab 4: SAML Identity Provider (IdP) - LocalDB Auth" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="lab06.html" title="Lab 6: SAML IdP Chaining to AzureAD (BIG-IP Primary IdP)" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>