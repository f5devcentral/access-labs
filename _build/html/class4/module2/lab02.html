<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>Lab 2: Create a SAML SP Per-Session Policy</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="Lab 2: Create a SAML SP Per-Session Policy"/>
  <meta name="product" content="F5 Identity and Access Management Solutions"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2021-06-21 13:23:29"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 Identity and Access Management Solutions" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab 2: Create a SAML SP Per-Session Policy &#8212; F5 Identity and Access Management Solutions  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/CoveoFullSearch.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/21fb8a09c3.css" type="text/css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Lab 3: Add a Webtop link to an existing Webtop" href="lab03.html" />
    <link rel="prev" title="Lab 1: Create a baseline Per-Session Policy" href="lab01.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 Identity and Access Management Solutions  </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../class1/class1.html">100 Series: Access Foundational Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class2/class2.html">200 Series: Assisted Deployment Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class3/class3.html">300 Series: Advanced Use Cases &amp; Solutions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../class4.html">400 Series: Access Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class5/class5.html">500 Series: Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archived/archived.html">Archived Identity &amp; Access Management Labs</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">Lab 2: Create a SAML SP Per-Session Policy</a><ul>
<li><a class="reference internal" href="#access-lab-environment">Access Lab Environment</a></li>
<li><a class="reference internal" href="#task-1-import-postman-collections">Task 1 - Import Postman Collections</a></li>
<li><a class="reference internal" href="#task-2-create-required-saml-objects">Task 2 - Create Required SAML Objects</a></li>
<li><a class="reference internal" href="#task-3-review-the-saml-sp-policy-item">Task 3 - Review the SAML SP Policy-item</a></li>
<li><a class="reference internal" href="#task-4-create-a-saml-sp-policy">Task 4 - Create a SAML SP policy</a></li>
<li><a class="reference internal" href="#task-5-lab-cleanup">Task 5 - Lab Cleanup</a></li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">F5 Identity and Access Management Solutions</a>
              &gt; <a href="../class4.html">400 Series: Access Automation</a>

          <span class="right">
             <a href="../../_sources/class4/module2/lab02.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/f5devcentral/f5-agility-labs-iam">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="lab-2-create-a-saml-sp-per-session-policy">
<h1>Lab 2: Create a SAML SP Per-Session Policy<a class="headerlink" href="#lab-2-create-a-saml-sp-per-session-policy" title="Permalink to this headline">¶</a></h1>
<p>In this lab your will learn about the API calls necessary to build a SAML SP Access Policy.  The graphic below depicts the basic flow required for creating the policy via API.</p>
<blockquote>
<div><img alt="image100" src="../../_images/1002.png" /></div></blockquote>
<div class="section" id="access-lab-environment">
<h2>Access Lab Environment<a class="headerlink" href="#access-lab-environment" title="Permalink to this headline">¶</a></h2>
<p>To access your dedicated student lab environment, you will need a web browser and Remote Desktop Protocol (RDP) client software. The web browser will be used to access the Unified Demo Framework (UDF) Training Portal. The RDP client will be used to connect to the jumphost, where you will be able to access the BIG-IP management interfaces (HTTPS, SSH).</p>
<ol class="arabic">
<li><p class="first">Click <strong>DEPLOYMENT</strong> located on the top left corner to display the environment</p>
</li>
<li><p class="first">Click <strong>ACCESS</strong> next to jumphost.f5lab.local</p>
<blockquote>
<div><p><img alt="image101" src="../../_images/1014.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Select your RDP resolution.</p>
</li>
<li><p class="first">The RDP client on your local host establishes a RDP connection to the Jumphost.</p>
</li>
<li><p class="first">Login with the following credentials:</p>
<blockquote>
<div><ul class="simple">
<li>User: <strong>f5lab\user1</strong></li>
<li>Password: <strong>user1</strong></li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="task-1-import-postman-collections">
<h2>Task 1 - Import Postman Collections<a class="headerlink" href="#task-1-import-postman-collections" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">From the Jumpbox, open <strong>Postman</strong> via the desktop shortcut or toolbar at the bottom</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Dismiss any prompts to update Postman.</p>
</div>
<p><img alt="image001" src="../../_images/00119.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Yes</strong> if prompted for “Do you want to allow this app to make changes to your device?”</p>
<blockquote>
<div><p><img alt="image002" src="../../_images/00220.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Import</strong> located on the top left of the Postman application</p>
<blockquote>
<div><p><img alt="image003" src="../../_images/00319.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Upload Files</strong></p>
<p><img alt="image004" src="../../_images/00420.png" /></p>
</li>
<li><p class="first">Navigate to C:\access-labs\class4\module2\student_files, select <strong>student-class4-module2-lab2.postman_collection.json</strong>, and click <strong>Open</strong></p>
<blockquote>
<div><p><img alt="image005" src="../../_images/00520.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Import</strong></p>
<p><img alt="image006" src="../../_images/00619.png" /></p>
</li>
<li><p class="first">A collection called <strong>student-class4-module2-lab2</strong> will appear on the left side in Postman</p>
</li>
</ol>
</div>
<div class="section" id="task-2-create-required-saml-objects">
<h2>Task 2 - Create Required SAML Objects<a class="headerlink" href="#task-2-create-required-saml-objects" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Expand the <strong>student-class4-module2-lab2</strong> collection and <strong>Create Access Objects</strong> folder.  These requests will import the IdP signing certificate, create a IdP Connector, and also the SP Service.  If you are unfamiliar with these requests please review <a class="reference internal" href="../module1/lab01.html#class4-module1-lab1"><span class="std std-ref">Creating a SAML Service Provider(SP) Service</span></a> for more detail.</p>
<blockquote>
<div><p><img alt="image007" src="../../_images/00720.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Hover over the collection name <strong>student-class4-module2-lab2</strong> with your mouse and click the <strong>Arrow</strong> icon.</p>
<p><img alt="image008" src="../../_images/00819.png" /></p>
</li>
<li><p class="first">Click the <strong>Create Access Objects</strong> folder. You will see the four requests in the folder.</p>
<blockquote>
<div><p><img alt="image009" src="../../_images/00919.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click the blue <strong>Run</strong>  button and Postman Runner will open.</p>
<p><img alt="image010" src="../../_images/01019.png" /></p>
</li>
<li><p class="first">Click the blue button <strong>Run student-class…</strong> and the API requests will start being sent to the BIG-IP.</p>
<blockquote>
<div><p><img alt="image011" src="../../_images/01120.png" /></p>
</div></blockquote>
</li>
<li><p class="first">The <strong>Pass</strong> circle will display a value 4.</p>
</li>
<li><p class="first">Close Runner by clicking the <strong>X</strong> in the top right corner.</p>
<blockquote>
<div><p><img alt="image012" src="../../_images/01220.png" /></p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="task-3-review-the-saml-sp-policy-item">
<h2>Task 3 - Review the SAML SP Policy-item<a class="headerlink" href="#task-3-review-the-saml-sp-policy-item" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Expand the <strong>Create Policy</strong> folder.  There are two subfolders containing the baseline policy and also the SAML SP Policy-item.  If you are unfamiliar with the requests inside of the baseline policy please review <a class="reference internal" href="lab01.html#class4-module2-lab1"><span class="std std-ref">Creating a Baseline Per-Session Policy</span></a>.</p>
<blockquote>
<div><p><img alt="image013" src="../../_images/01321.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Expand the Policy-item SAML SP subfolder</p>
<blockquote>
<div><p><img alt="image014" src="../../_images/01419.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>bigip-create-agent-saml-sp</strong> and then <strong>Body</strong>.  The JSON Body specifies the SP service using the <strong>server</strong> JSON key.   This is the name of the service we just created using runner.</p>
<blockquote>
<div><p><img alt="image015" src="../../_images/01520.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>bigip-create-policy item-saml-sp</strong> and then <strong>Body</strong>.  The JSON Body of the policy-item contains a reference to the previously reviewed SAML agent along with two branch rules.  One branch rule contains an expression that if the SAML auth is 1(True) then proceed to the allow terminal.  Everything else goes down the fallback branch to the Deny Terminal.  Lastly take notice of the SAML SP policy-item name because we will be using it later in the lab.</p>
<blockquote>
<div><p><img alt="image016" src="../../_images/01618.png" /></p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="task-4-create-a-saml-sp-policy">
<h2>Task 4 - Create a SAML SP policy<a class="headerlink" href="#task-4-create-a-saml-sp-policy" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Expand the <strong>Baseline Policy</strong> subfolder.</p>
<p><img alt="image017" src="../../_images/01718.png" /></p>
</li>
<li><p class="first">We will now add the policy-item SAML SP folder to the baseline Policy folder in its proper place.  Click and drag the <strong>policy-item SAML SP</strong> folder between the Allow Ending and Start Item folders.</p>
<blockquote>
<div><p><img alt="image018" src="../../_images/01818.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Now the the requests are in the folder we need to modify a couple baseline requests to ensure the policy is created correctly.</p>
</li>
<li><p class="first">First, we need to adjust the start item’s rule to go to the <strong>SAML SP Policy-item</strong>.   Open the <strong>Start Item</strong> folder, click on <strong>bigip-create-policy item-start</strong>, and then <strong>Body</strong>.</p>
</li>
<li><p class="first">Change the NextItem key value from <strong>“/Common/{{VS_NAME}}-psp_end_deny”</strong> to <strong>“/Common/{{VS_NAME}}-psp_act_saml_auth”</strong>.</p>
<blockquote>
<div><p><img alt="image019" src="../../_images/01919.png" /></p>
</div></blockquote>
</li>
<li><p class="first">After you are done editing the request, click <strong>Save</strong> in the upper right corner.  Runner will not pickup any changes that are not saved causing the automation to fail.</p>
</li>
<li><p class="first">Now the workflow of the policy is complete. The flow of the policy is as follows:  A user enters the <strong>start</strong> policy-item, proceed to the <strong>SAML Auth</strong> Policy-item.Then based on success or failure of SAML authentication a user will proceed to the <strong>Allow</strong> or <strong>Deny</strong> Terminal.</p>
</li>
<li><p class="first">Every Policy-item must be defined inside of the <strong>items</strong> list of the policy.  Expand the <strong>Create Policy</strong> subfolder located inside the <strong>Baseline Policy</strong> folder, click on <strong>bigip-create-policy</strong> and then <strong>Body</strong>.</p>
</li>
<li><p class="first">Copy and paste the below JSON inside the items array in front of the allow Terminal.  The placement of policy-items inside of the items array is not important to the order they used within branch rules or Visual Policy Editors.</p>
<blockquote>
<div><div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;{{VS_NAME}}-psp_act_saml_auth&quot;</span><span class="p">,</span>
    <span class="nt">&quot;partition&quot;</span><span class="p">:</span> <span class="s2">&quot;Common&quot;</span>
<span class="p">},</span>
</pre></div>
</div>
<p><img alt="image020" src="../../_images/02018.png" /></p>
</div></blockquote>
</li>
<li><p class="first">After you are done editing the request, click <strong>Save</strong> in the upper right corner.  Runner will not pickup any changes that are not saved causing the automation to fail.</p>
</li>
<li><p class="first">Now that we have the automation updated let’s deploy the policy.  Hover over the Collection name <strong>student-class4-module2-lab2</strong> with your mouse and click the <strong>Arrow</strong> icon.</p>
<p><img alt="image021" src="../../_images/02117.png" /></p>
</li>
<li><p class="first">Click <strong>student-class4-module…</strong> to return to the main folder if you are not already there.</p>
<blockquote>
<div><p><img alt="image035" src="../../_images/03512.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click the <strong>Create Policy</strong> folder.</p>
<blockquote>
<div><p><img alt="image022" src="../../_images/02217.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click the blue <strong>Run</strong> button and Postman Runner will open.</p>
<p><img alt="image023" src="../../_images/02318.png" /></p>
</li>
<li><p class="first">Click the blue button <strong>Run student-class…</strong> and the API requests will start being sent to the BIG-IP.</p>
<blockquote>
<div><p><img alt="image024" src="../../_images/02418.png" /></p>
</div></blockquote>
</li>
<li><p class="first">The <strong>Pass</strong> circle will display a value 2.</p>
</li>
<li><p class="first">Close Runner by clicking the <strong>X</strong> in the top right corner.</p>
<blockquote>
<div><p><img alt="image025" src="../../_images/02518.png" /></p>
</div></blockquote>
</li>
<li><p class="first">From the jumphost, open browser and navigate to <a class="reference external" href="https://bigip1.f5lab.local">https://bigip1.f5lab.local</a></p>
</li>
<li><p class="first">Login to the BIG-IP GUI with the following credentials:</p>
<blockquote>
<div><ul class="simple">
<li>Username: <strong>admin</strong></li>
<li>Password: <strong>admin</strong></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Navigate to Access&gt;&gt;Profiles/Policies&gt;&gt;Access Profiles (Per-Session Policies).  Do not click the plus symbol.</p>
<blockquote>
<div><p><img alt="image026" src="../../_images/02617.png" /></p>
</div></blockquote>
</li>
<li><p class="first">The policy <strong>class4-module2-lab2-psp</strong> you created via automation is displayed.  Click <strong>Edit</strong> to view Visual Policy Editor(VPE).</p>
<blockquote>
<div><p><img alt="image027" src="../../_images/02717.png" /></p>
</div></blockquote>
</li>
<li><p class="first">The policy was successfully deployed with the SAML Auth Policy-Item.</p>
<blockquote>
<div><p><img alt="image034" src="../../_images/03414.png" /></p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="task-5-lab-cleanup">
<h2>Task 5 - Lab Cleanup<a class="headerlink" href="#task-5-lab-cleanup" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Expand the <strong>Lab Cleanup</strong> subfolder and its subfolders. There are a total of five requests.  The first two requests delete the Policy, while the last three requests delete the SP Service, IdP Connector, and IdP signing certificate.  To understand these requests further review <a class="reference internal" href="lab01.html#class4-module2-lab1-delete"><span class="std std-ref">Deleting an Access Profile</span></a> or <a class="reference internal" href="../module1/lab01.html#class4-module1-lab1-delete"><span class="std std-ref">Deleting a SAML Service Provider(SP) Service Configuration</span></a></p>
<p><img alt="image028" src="../../_images/02817.png" /></p>
</li>
<li><p class="first">Hover over the Collection name <strong>student-class4-module2-lab2</strong> with your mouse and click the <strong>Arrow</strong> icon.</p>
<p><img alt="image029" src="../../_images/02917.png" /></p>
</li>
</ol>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Click <strong>student-class4-module2-lab2</strong> to return to the main folder if you are not already there.</p>
<p><img alt="image036" src="../../_images/03611.png" /></p>
</li>
</ol>
</div></blockquote>
<ol class="arabic">
<li><p class="first">Click the <strong>Lab Cleanup</strong> folder.</p>
<blockquote>
<div><p><img alt="image030" src="../../_images/03015.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click the blue <strong>Run</strong> button and Postman Runner will open.</p>
<p><img alt="image031" src="../../_images/03115.png" /></p>
</li>
<li><p class="first">Click the blue button <strong>Run student-class…</strong> and the API requests will start being sent to the BIG-IP.</p>
<blockquote>
<div><p><img alt="image032" src="../../_images/03213.png" /></p>
</div></blockquote>
</li>
<li><p class="first">The <strong>Pass</strong> circle will display a value of 5.</p>
<blockquote>
<div><p><img alt="image033" src="../../_images/03314.png" /></p>
</div></blockquote>
</li>
<li><p class="first">From Postman, Click the <strong>3 dots</strong> on the bottom right of the student-class4-module2-lab2 Collection.</p>
</li>
<li><p class="first">Click <strong>Delete</strong></p>
<blockquote>
<div><p><img alt="image037" src="../../_images/03711.png" /></p>
</div></blockquote>
</li>
</ol>
<p>This concludes the lab on creating and deleting a SAML SP Access Policy.</p>
<blockquote>
<div><img alt="image000" src="../../_images/00031.png" /></div></blockquote>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="lab01.html" title="Lab 1: Create a baseline Per-Session Policy" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="lab03.html" title="Lab 3: Add a Webtop link to an existing Webtop" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>