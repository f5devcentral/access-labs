<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>Lab 3: Server-Side Single Sign-On</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="Lab 3: Server-Side Single Sign-On"/>
  <meta name="product" content="F5 Identity and Access Management Solutions"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2021-06-21 14:22:47"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 Identity and Access Management Solutions" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab 3: Server-Side Single Sign-On &#8212; F5 Identity and Access Management Solutions  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/CoveoFullSearch.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/21fb8a09c3.css" type="text/css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Lab 4: Webtop Access Policy Build" href="lab04.html" />
    <link rel="prev" title="Lab 2: Step up Authentication with Per-Request Policies" href="lab02.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 Identity and Access Management Solutions  </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../class1.html">100 Series: Access Foundational Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class2/class2.html">200 Series: Assisted Deployment Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class3/class3.html">300 Series: Advanced Use Cases &amp; Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class4/class4.html">400 Series: Access Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class5/class5.html">500 Series: Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archived/archived.html">Archived Identity &amp; Access Management Labs</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">Lab 3: Server-Side Single Sign-On</a><ul>
<li><a class="reference internal" href="#task-1-policy-review">Task 1: Policy review</a></li>
<li><a class="reference internal" href="#task-2-supporting-apm-objects-review">Task 2: Supporting APM Objects review</a></li>
<li><a class="reference internal" href="#task-3-access-profile-configuration">Task 3: Access Profile Configuration</a></li>
<li><a class="reference internal" href="#task-4-customized-ltm-profile-settings">Task 4: Customized LTM Profile settings</a></li>
<li><a class="reference internal" href="#task-5-logging-in-from-a-users-perspective">Task 5: Logging in from a user’s perspective</a></li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">F5 Identity and Access Management Solutions</a>
              &gt; <a href="../class1.html">100 Series: Access Foundational Concepts</a>

          <span class="right">
             <a href="../../_sources/class1/module2/lab03.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/f5devcentral/f5-agility-labs-iam">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="lab-3-server-side-single-sign-on">
<h1>Lab 3: Server-Side Single Sign-On<a class="headerlink" href="#lab-3-server-side-single-sign-on" title="Permalink to this headline">¶</a></h1>
<p>The purpose of this lab is to demonstrate Single Sign-On capabilities of APM.  The SSO Credential Mapping action enables users to forward
stored user names and passwords to applications and servers automatically, without having to input credentials repeatedly.   This allows single
sign-on (SSO) functionality for secure user access.  As different applications and resources support different authentication mechanisms, the SSO system
may be required to store and transform credentials to meet these requirements. For example, username and password may be transformed into forms-based
authentication, a SAML assertion into Kerberos or Kerberos authentication into SAML.</p>
<p>Although a number of different SSO methods exist, this lab will demonstrate access single SSO method certificate authentication on the client side to Kerberos authentication to the backend server</p>
<p>Objective:</p>
<ul class="simple">
<li>Gain an understanding of authentication transformation through APM, client side vs server side</li>
<li>Gain an understanding of the leveraging different auth methods</li>
<li>Develop an awareness of the different deployment models for single sign on</li>
</ul>
<p>Lab Requirements:</p>
<ul class="simple">
<li>Virtual Servers policies and configuration for this lab were completed through the automation run in Lab1.  We will review the components involved in this SSO solution.</li>
</ul>
<p>Estimated completion time: 15 minutes</p>
<div class="section" id="task-1-policy-review">
<h2>Task 1: Policy review<a class="headerlink" href="#task-1-policy-review" title="Permalink to this headline">¶</a></h2>
<p>..Note::  All the objects and configuration have been completed for you.  In this lab we will explore the configuration and test.</p>
<ol class="arabic">
<li><p class="first">From the jumphost launch Chrome and login to bigip1.f5lab.local.  admin/admin</p>
</li>
<li><p class="first">Navigate to <strong>Access</strong> -&gt; <strong>Profiles/Policies</strong> -&gt; <strong>Access Profiles (Per-Session Policies)</strong></p>
</li>
<li><p class="first">Locate solution6-psp and click <strong>Edit</strong></p>
<blockquote>
<div><p><img alt="Lab3-Image1" src="../../_images/Lab3-Image1.png" /></p>
<p>Let’s walk through the policy flow:</p>
<ul class="simple">
<li>A user is prompted to select their certificate.</li>
<li>The validation of the user certificates is controlled via CA bundles selected in the Client-side SSL Profile.</li>
<li>The certificate is validated by OCSP if the user presents a certificate issued by a trusted CA</li>
<li>The othername field is extracted from the certificate</li>
<li>A LDAP query is performed to collect the sAMAccountName of the user</li>
<li>The domain and username variables are set</li>
<li>The user is granted access via the Allow Terminal</li>
<li>If the LDAP Query is unsuccessful, the user proceeds down the fallback branch to the Deny Terminal</li>
<li>If the OCSP check is unsuccessful, the user proceeds down the fallback branch to the Deny Terminal</li>
<li>If the user fails to present a certificate, the user proceeds down the fallback branch to the Deny Terminal</li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="task-2-supporting-apm-objects-review">
<h2>Task 2: Supporting APM Objects review<a class="headerlink" href="#task-2-supporting-apm-objects-review" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Access</strong> -&gt; <strong>Authentication</strong> -&gt; <strong>OCSP Responder</strong> and click on the AAA OCSP Responder object <strong>solution6-ocsp-servers</strong></p>
</li>
<li><p class="first">Change the configuration from <strong>Basic</strong> to <strong>Advanced</strong>.  The OCSP Responder has been configured with the following settings:</p>
<blockquote>
<div><ul class="simple">
<li>URL: this field is only used if you check the Ignore AIA field</li>
<li>Certificate Authority File: contains the root ca bundle</li>
<li>Certificate Authority Path: this field is only used if you check the Ignore AIA field</li>
<li>The rest of the settings are default</li>
</ul>
<p><img alt="Lab3-Image10" src="../../_images/Lab3-Image10.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Navigate to <strong>Access</strong> -&gt; <strong>Authentication</strong> -&gt; <strong>LDAP</strong> for the AAA LDAP Object</p>
</li>
<li><p class="first">Click on <strong>solution6-ldap-servers</strong>. A single LDAP server of 10.1.20.7 has been configured with a admin service account to support queries</p>
<blockquote>
<div><p><img alt="Lab3-Image11" src="../../_images/Lab3-Image11.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Navigated to <strong>Access</strong> -&gt; <strong>Single Sign-On</strong> -&gt; <strong>Kerberos</strong> and review the Kerberos SSO Object <strong>solution6-kerbsso</strong></p>
<blockquote>
<div><ul class="simple">
<li>The Username Source field has been modified from the default to reference the sAMAccountName stored in session.logon.last.username</li>
<li>Kerberos Realm has been set to the Active Directory domain (realms should always be in uppercase)</li>
<li>The service account used for Kerberos Constrained Delegation (Service Account Names should be in SPN format)</li>
<li>SPN Pattern has been hardcoded to HTTP/solution6.acme.com (This is only necessary if the SPN doesn’t match the FQDN typed in the web browser by the user)</li>
</ul>
<p><img alt="Lab3-Image12" src="../../_images/Lab3-Image12.png" /></p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="task-3-access-profile-configuration">
<h2>Task 3: Access Profile Configuration<a class="headerlink" href="#task-3-access-profile-configuration" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Access</strong> -&gt; <strong>Profiles/Policies</strong> -&gt; <strong>Access Profiles (Per-Session Policies)</strong> and locate the <strong>solution6-psp</strong> profile.  Click on the profile and review the customized APM Profile Settings</p>
</li>
<li><p class="first">Click on the SSO/Auth Domains of the APM profile and note it is configured with the Kerberos SSO Profile which will be used to authenticate to the backend server.</p>
<blockquote>
<div><p><img alt="Lab3-Image9" src="../../_images/Lab3-Image9.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click on <strong>Access Policy</strong> and the <strong>Edit Access Policy for Profile “solution6-psp”</strong> link</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can also see from this screen any AAA server objects associated with this profile/policy.  You can see we will be using the OCSP responder and</p>
</div>
</div></blockquote>
</li>
<li><p class="first">Click on the <strong>On-Demand Cert Auth</strong> box in the VPE.  The agent uses the default settings of <strong>Auth Mode</strong> = <strong>Request</strong></p>
<blockquote>
<div><p><img alt="Lab3-Image2" src="../../_images/Lab3-Image2.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Cancel</strong></p>
</li>
<li><p class="first">Click on the <strong>OCSP Auth</strong> box.  The OCSP Agent validates the certificate against the OCSP responder configured</p>
<blockquote>
<div><p><img alt="Lab3-Image3" src="../../_images/Lab3-Image3.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click Cancel</p>
</li>
<li><p class="first">Click the <strong>upn extract</strong> box.  Under Assignment click on the <strong>Change</strong> link</p>
<blockquote>
<div><p><img alt="Lab3-Image4" src="../../_images/Lab3-Image4.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Note that a custom variable will be created called session.custom.upn.  We will write an expression that will extract the othername:UPN field from the certificate for a new custom variable.</p>
<blockquote>
<div><pre class="literal-block">
set x509e_fields [split [mcget {session.ssl.cert.x509extension}] &quot;n&quot;];
# For each element in the list:
foreach field $x509e_fields {
# If the element contains UPN:
if { $field contains &quot;othername:UPN&quot; } {
## set start of UPN variable
set start [expr {[string first &quot;othername:UPN&lt;&quot; $field] +14}]
# UPN format is &lt;user&#64;domain&gt;
# Return the UPN, by finding the index of opening and closing brackets, then use string range to get everything between.
return [string range $field $start [expr { [string first &quot;&gt;&quot; $field $start] - 1 } ] ];  } }
# Otherwise return UPN Not Found:
return &quot;UPN-NOT-FOUND&quot;;

<img alt="Lab3-Image15" src="../../_images/Lab3-Image15.png" />
</pre>
</div></blockquote>
</li>
<li><p class="first">Click Cancel twice</p>
</li>
<li><p class="first">Click the LDAP Query box. The LDAP query connects to the LDAP server to the dc=f5lab,dc=local DN for a user that contains the userPrincipalName matching the value stored in session.custom.upn.</p>
</li>
<li><p class="first">You can see that we are using the AAA LDAP object created early to validate the variable session.custom.upn. The LDAP query requests the sAMAccountName attribute if the user is found.</p>
<blockquote>
<div><p><img alt="Lab3-Image5" src="../../_images/Lab3-Image5.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click on <strong>Branch Rules</strong>. The branch rule was modified to only require a LDAP Query passed condition</p>
<blockquote>
<div><p><img alt="Lab3-Image6" src="../../_images/Lab3-Image6.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Click <strong>Cancel</strong></p>
</li>
<li><p class="first">Click the <strong>set_variables</strong> box.  Two session variables are set</p>
<blockquote>
<div><ul class="simple">
<li>session.logon.last.username is populated with the value of the sAMAccountName returned in the LDAP query</li>
<li>session.logon.last.domain is populated with a static value for the Active Directory domain F5LAB.LOCAL</li>
</ul>
<p><img alt="Lab3-Image7" src="../../_images/Lab3-Image7.png" /></p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="task-4-customized-ltm-profile-settings">
<h2>Task 4: Customized LTM Profile settings<a class="headerlink" href="#task-4-customized-ltm-profile-settings" title="Permalink to this headline">¶</a></h2>
<p>We will need to make some modifications to the client SSL profile to accommodate Certificate authentication.</p>
<ol class="arabic">
<li><p class="first">Navigate to <strong>Local Traffic</strong> from the left menu.  Under Partitions select the drop down and choose <strong>solution6</strong>.  This will change the partition so that you can see the LTM objects used in this lab.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We deployed the LTM objects in to another administrative partition for the purposes of separating the objects.  If you were to deploy this in your own environment using a partition is not a requirement.</p>
</div>
<p><img alt="Lab3-Image16" src="../../_images/Lab3-Image16.png" /></p>
</div></blockquote>
</li>
<li><p class="first">Navigate to <strong>Local Traffic</strong> -&gt; <strong>Profiles</strong> -&gt; <strong>SSL</strong> -&gt; <strong>Client</strong>.  Click on <strong>solution6-clientssl</strong>.</p>
</li>
<li><p class="first">In he Client-side SSL profile scroll down to the <strong>Client Authentication</strong> section and notice it has been modified to support certificate authentication</p>
<blockquote>
<div><p><strong>Trusted Certificate Authorities has been set to ca.f5lab.local</strong></p>
<blockquote>
<div><ul class="simple">
<li>The bundle validates client certificates by these issuers</li>
<li>The bundle must include all CAs in the chain</li>
</ul>
</div></blockquote>
<p><strong>Advertised Certificate Authorities has ben set to ca.f5lab.local</strong></p>
<blockquote>
<div><ul class="simple">
<li>The bundle controls which certificates are displayed to a user when they are prompted to select their certificate</li>
</ul>
</div></blockquote>
<p><img alt="Lab3-Image8" src="../../_images/Lab3-Image8.png" /></p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="task-5-logging-in-from-a-users-perspective">
<h2>Task 5: Logging in from a user’s perspective<a class="headerlink" href="#task-5-logging-in-from-a-users-perspective" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Open an incognito window in the Chrome browser and access <a class="reference external" href="https://solution6.acme.com">https://solution6.acme.com</a></p>
</li>
<li><p class="first">You will be presented with three possible certificates.  Choose <strong>User1</strong> and click <strong>OK</strong></p>
<p><img alt="Lab3-Image13" src="../../_images/Lab3-Image13.png" /></p>
</li>
<li><p class="first">If successful the user is granted access to the application</p>
<blockquote>
<div><p><img alt="Lab3-Image14" src="../../_images/Lab3-Image14.png" /></p>
</div></blockquote>
</li>
</ol>
<p>Lab 3 is now complete.</p>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="lab02.html" title="Lab 2: Step up Authentication with Per-Request Policies" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="lab04.html" title="Lab 4: Webtop Access Policy Build" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>